<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {% assign raw_novel_title = page.Title | default: page.title | default: page.novel %}
    {% assign novel_display_title = raw_novel_title | replace: ' - Chapters', '' | strip %}
    {% if novel_display_title == '' or raw_novel_title contains 'Chapters' %}
      {% assign _novel_words = page.novel | replace: '-', ' ' | replace: '_', ' ' | split: ' ' %}
      {% capture _novel_title_from_slug %}{% for w in _novel_words %}{% if w != '' %}{{ w | capitalize }}{% unless forloop.last %} {% endunless %}{% endif %}{% endfor %}{% endcapture %}
      {% assign novel_display_title = _novel_title_from_slug | strip %}
    {% endif %}
    <title>{{ novel_display_title }} · {{ site.title }}</title>
    <meta name="theme-color" content="#ffffff" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
:root{
  /* light default */
  --bg:#ffffff;
  --text:#111111;
  --muted:#444444;
  --card:#ffffff;
  --border:#e6e6e6;
  --link:#111111;
  --btn-bg:#111111; --btn-text:#ffffff; --btn-brd:#111111;

  --pill:#eef; --pill-brd:#dbe;
  --pill-ok:#e8f7ec; --pill-ok-brd:#c9ebd5;
  --pill-wip:#fff5e6; --pill-wip-brd:#ffe0b3;

  color-scheme: light dark;
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b0e13;
    --text:#e7eaf0;
    --muted:#a8b2c1;
    --card:#11151d;
    --border:#253043;
    --link:#e7eaf0;
    --btn-bg:#e7eaf0; --btn-text:#0b0e13; --btn-brd:#e7eaf0;

    --pill:#253043; --pill-brd:#32405a;
    --pill-ok:#15351f; --pill-ok-brd:#275d3b;
    --pill-wip:#3b2d17; --pill-wip-brd:#5c4321;
  }
}

/* Manual override has priority over system */
:root[data-theme="light"]{
  --bg:#ffffff; --text:#111111; --muted:#444444; --card:#ffffff; --border:#e6e6e6; --link:#111111;
  --btn-bg:#111111; --btn-text:#ffffff; --btn-brd:#111111;
  --pill:#eef; --pill-brd:#dbe; --pill-ok:#e8f7ec; --pill-ok-brd:#c9ebd5; --pill-wip:#fff5e6; --pill-wip-brd:#ffe0b3;
}
:root[data-theme="dark"]{
  --bg:#0b0e13; --text:#e7eaf0; --muted:#a8b2c1; --card:#11151d; --border:#253043; --link:#e7eaf0;
  --btn-bg:#e7eaf0; --btn-text:#0b0e13; --btn-brd:#e7eaf0;
  --pill:#253043; --pill-brd:#32405a; --pill-ok:#15351f; --pill-ok-brd:#275d3b; --pill-wip:#3b2d17; --pill-wip-brd:#5c4321;
}

body{background:var(--bg); color:var(--text); margin:0; font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif}
a{color:var(--link); text-decoration:none}
a:hover{text-decoration:underline}

/* Header styles */
.site-header{position:sticky;top:0;z-index:10;background:color-mix(in oklab, var(--bg), var(--card) 40%);border-bottom:1px solid var(--border);backdrop-filter:blur(8px);padding:.85rem 1.25rem;font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif}
.header-content{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.brand{font-weight:600;font-size:1.05rem;font-family:"Merriweather",serif}
.header-right{display:flex;align-items:center;gap:1rem}
.crumbs{display:flex;align-items:center;gap:.35rem;font-size:.9rem;color:var(--muted)}
.crumbs a{color:var(--muted)}
.crumbs a:hover{color:var(--text);text-decoration:none}

/* Main container */
.container{max-width:1100px;margin:0 auto;padding:0 1.25rem}

.novel-hero{display:grid;grid-template-columns:120px 1fr;gap:1rem;align-items:center;margin:1.5rem 0;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
.novel-hero-cover{position:relative;width:120px;z-index:1}
.novel-hero-cover>img{display:block;width:120px;height:180px;object-fit:cover;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,.12);cursor:zoom-in}
.novel-hero-cover:focus{outline:2px solid color-mix(in oklab, var(--btn-brd), transparent 38%);outline-offset:4px;border-radius:10px}
.cover-popover{position:fixed;left:50%;top:50%;width:min(560px,86vw);max-height:88vh;padding:.55rem;border:1px solid var(--border);border-radius:14px;background:var(--card);box-shadow:0 28px 72px rgba(0,0,0,.42);opacity:0;transform:translate(-50%,-50%) scale(.92);pointer-events:none;z-index:999;transition:opacity .18s ease,transform .18s ease}
.cover-popover img{display:block;width:100%;max-height:calc(88vh - 1.1rem);height:auto;object-fit:contain;border-radius:10px;background:color-mix(in oklab, var(--card), var(--bg) 25%)}
.novel-hero-cover:hover .cover-popover,
.novel-hero-cover:focus .cover-popover,
.novel-hero-cover:focus-within .cover-popover{opacity:1;transform:translate(-50%,-50%) scale(1)}
@media (min-width:720px){.novel-hero{grid-template-columns:180px 1fr}.novel-hero-cover{width:180px}.novel-hero-cover>img{width:180px;height:270px}}
@media (max-width:640px){.cover-popover{width:min(430px,92vw)}}
.novel-title{margin:0;font-size:clamp(1.4rem,2.5vw,2rem);line-height:1.15}
.novel-meta{display:flex;gap:.5rem;flex-wrap:wrap;margin:.25rem 0 .5rem}
.badge{font-size:.8rem;padding:.1rem .35rem;border-radius:999px;background:var(--pill);border:1px solid var(--pill-brd);white-space:nowrap}
.badge.complete{background:var(--pill-ok);border-color:var(--pill-ok-brd)}
.badge.incomplete{background:var(--pill-wip);border-color:var(--pill-wip-brd)}
.novel-actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.6rem 0 0}
.novel-actions a{display:inline-block;padding:.6rem .9rem;border-radius:8px;text-decoration:none;border:1px solid var(--border);background:var(--card);color:var(--link)}
.novel-actions a.primary{background:var(--btn-bg);color:var(--btn-text);border-color:var(--btn-brd)}
.novel-actions a:hover{filter:brightness(1.05)}
.novel-blurb{margin:.5rem 0 0;color:var(--muted);max-width:65ch}
.chapter-tools{display:flex;gap:.6rem;align-items:center;margin:1.5rem 0 .6rem}
.chapter-tools input[type=search]{max-width:420px;width:100%;padding:.55rem .7rem;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text)}
.chapter-list{list-style:none;padding:0;margin:0;display:grid;gap:.4rem}
.chapter-list li a{display:flex;gap:.6rem;align-items:center;padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:inherit;background:var(--card)}
.chapter-list li a:hover{background:color-mix(in oklab, var(--card), var(--text) 6%)}
.chapter-list li.last-read a{border-color:color-mix(in oklab, var(--btn-brd), var(--border) 45%);box-shadow:0 0 0 1px color-mix(in oklab, var(--btn-brd), transparent 65%) inset}
.chapter-list li.completed a{opacity:.58;filter:saturate(.15)}
.chapter-list li.completed a:hover{opacity:.78}
.chapter-no{font-variant-numeric:tabular-nums;color:var(--muted);min-width:4.5rem}
.chapter-title{flex:1;min-width:0}
.small-note{font-size:.85rem;color:var(--muted)}
.related-novels{margin:0 0 1.1rem;padding:.95rem;border:1px solid var(--border);border-radius:12px;background:var(--card)}
.related-novels[hidden]{display:none}
.related-novels h2{margin:0;font-size:1.05rem;font-family:"Merriweather",serif}
.related-novels .small-note{margin:.25rem 0 0}
.related-novels{--related-card-width:150px}
.related-list{list-style:none;padding:0 0 .35rem;margin:.75rem 0 0;display:flex;gap:.62rem;overflow-x:auto;overflow-y:hidden;scroll-snap-type:x proximity;overscroll-behavior-x:contain;-webkit-overflow-scrolling:touch}
.related-list li{flex:0 0 var(--related-card-width);scroll-snap-align:start}
.related-list::-webkit-scrollbar{height:10px}
.related-list::-webkit-scrollbar-thumb{background:color-mix(in oklab, var(--muted), transparent 40%);border-radius:999px}
.related-list::-webkit-scrollbar-track{background:color-mix(in oklab, var(--card), var(--bg) 28%);border-radius:999px}
.related-card{display:grid;grid-template-rows:auto 1fr;height:100%;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:color-mix(in oklab, var(--card), var(--bg) 20%);text-decoration:none;color:inherit;transition:transform .16s ease,box-shadow .16s ease,background-color .16s ease}
.related-card:hover{transform:translateY(-3px);box-shadow:0 14px 32px rgba(0,0,0,.17);background:color-mix(in oklab, var(--card), var(--text) 5%);text-decoration:none}
.related-cover-wrap{display:block;aspect-ratio:2/3;overflow:hidden;background:color-mix(in oklab, var(--card), var(--bg) 35%)}
.related-cover-wrap picture,
.related-cover-wrap img{display:block;width:100%;height:100%;object-fit:cover}
.related-body{display:grid;gap:.5rem;align-content:start;padding:.6rem .65rem .7rem}
.related-title{font-weight:600;line-height:1.24;min-width:0}
.related-meta{display:flex;gap:.33rem;flex-wrap:wrap}
.related-badge{font-size:.7rem;padding:.14rem .42rem;border-radius:999px;border:1px solid var(--pill-brd);background:var(--pill);color:inherit;white-space:nowrap}
.related-badge.relation{border-color:color-mix(in oklab, var(--btn-brd), var(--border) 45%)}
.related-badge.complete{background:var(--pill-ok);border-color:var(--pill-ok-brd)}
.related-badge.incomplete{background:var(--pill-wip);border-color:var(--pill-wip-brd)}
@media (max-width:640px){.related-novels{--related-card-width:132px}}
/* theme toggle */
.theme-toggle{margin-left:auto;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:8px;padding:.45rem .6rem;cursor:pointer;font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif}
.theme-toggle:hover{filter:brightness(1.05)}
</style>
</head>
<body data-novel-slug="{{ page.novel | escape }}">
{% assign novel_slug = page.novel %}
{% assign cover_url = page.cover | default: '/images/' | append: novel_slug | append: '-cover.png' %}
{% assign status = page.status | default: 'Incomplete' %}
{% assign blurb = page.blurb %}
{% assign pathprefix = '/novel/' | append: novel_slug | append: '/' %}
{% assign items = site.pages | where_exp: 'p', 'p.url contains pathprefix' | where_exp: 'p', 'p.name != "index.md"' | sort: 'order' %}

<!-- optional theme-color for mobile -->
<meta name="theme-color" content="#ffffff">

<header class="site-header">
  <div class="header-content">
    <a class="brand" href="{{ "/" | relative_url }}">{{ site.title }}</a>
    <div class="header-right">
      <nav class="crumbs">
        <a href="/novel/">All Novels</a>
      </nav>
      <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle theme">🌙</button>
    </div>
  </div>
</header>

<div class="container">
<div class="novel-hero">
  <div class="novel-hero-cover" tabindex="0">
    <img src="{{ cover_url | relative_url }}" alt="{{ novel_display_title }}">
    <div class="cover-popover" aria-hidden="true">
      <img src="{{ cover_url | relative_url }}" alt="">
    </div>
  </div>
  <div>
    <h1 class="novel-title">{{ novel_display_title }}</h1>
    <div class="novel-meta">
      <span class="badge {{ status | downcase }}">{{ status }}</span>
      <span class="badge">Chapters: {{ items | size }}</span>
    </div>
    {% if blurb %}<p class="novel-blurb">{{ blurb }}</p>{% endif %}

    <div class="novel-actions">
      {% assign first = items | first %}
      {% if first %}
        <a class="primary" id="startReading" href="{{ first.url | relative_url }}">Start reading</a>
      {% endif %}
      <a id="continueReading" href="#" style="display:none">Continue</a>
      <a href="/novel/">Back to all novels</a>
    </div>
  </div>
</div>

<div class="chapter-tools">
  <input id="chapterSearch" type="search" placeholder="Search chapters… (title or number)">
  <span class="small-note">Tip: we’ll remember your last chapter.</span>
</div>

<section id="relatedNovelsSection" class="related-novels" hidden>
  <h2>Related novels</h2>
  <p id="relatedNovelsSummary" class="small-note"></p>
  <ul id="relatedNovelsList" class="related-list"></ul>
</section>

<ul id="chapterList" class="chapter-list">
  {% for ch in items %}
    <li data-title="{{ ch.Title | default: ch.title | downcase }}" data-no="{{ ch.order }}" data-url="{{ ch.url | relative_url }}">
      <a href="{{ ch.url | relative_url }}">
        <span class="chapter-no">Chapter {{ ch.order }}</span>
        <span class="chapter-title">{{ ch.Title | default: ch.title }}</span>
      </a>
    </li>
  {% endfor %}
</ul>

</div>
<script>
// Continue Reading + chapter progress UI (per novel)
(function() {
  var slug = (document.body && document.body.dataset && document.body.dataset.novelSlug) || '';
  var lastUrlKey = 'novel:'+slug+':lastUrl';
  var stateKey = 'novel:'+slug+':state';
  var chaptersKey = 'novel:'+slug+':chapters';
  var continueBtn = document.getElementById('continueReading');
  var startBtn = document.getElementById('startReading');
  var list = document.getElementById('chapterList');
  var state = {};
  var chapters = {};
  var saved = '';

  function safeParse(raw, fallback) {
    if (!raw) return fallback;
    try { return JSON.parse(raw); } catch (e) { return fallback; }
  }

  function normalizePath(url) {
    if (!url) return '';
    var s = String(url);
    try {
      if (/^https?:\/\//i.test(s)) s = new URL(s).pathname;
    } catch (e) {}
    s = s.replace(/\/index\.html$/i, '/');
    if (s.length > 1) s = s.replace(/\/+$/, '');
    return s;
  }

  function getListItemByUrl(url) {
    if (!list) return null;
    var target = normalizePath(url);
    if (!target) return null;
    var match = null;
    list.querySelectorAll('li').forEach(function(li) {
      if (!match && normalizePath(li.dataset.url) === target) match = li;
    });
    return match;
  }

  function getNextListItem(li) {
    if (!li) return null;
    var next = li.nextElementSibling;
    while (next && next.tagName !== 'LI') next = next.nextElementSibling;
    return next || null;
  }

  function renderContinue(url) {
    if (!continueBtn || !url) return;
    var li = getListItemByUrl(url);
    var chapterNo = li ? li.dataset.no : ((state && state.lastOrder != null) ? state.lastOrder : '');
    var label = chapterNo ? ('Continue Chapter ' + chapterNo) : 'Continue';
    continueBtn.href = url;
    continueBtn.textContent = label;
    continueBtn.setAttribute('aria-label', label);
    continueBtn.style.display = 'inline-block';
  }

  try {
    state = safeParse(localStorage.getItem(stateKey), {}) || {};
    var rawChapters = safeParse(localStorage.getItem(chaptersKey), {}) || {};
    Object.keys(rawChapters).forEach(function(k) {
      chapters[normalizePath(k)] = rawChapters[k];
    });
    saved = (state && state.lastUrl) || localStorage.getItem(lastUrlKey) || '';
  } catch (e) {
    state = {};
    chapters = {};
    saved = '';
  }

  var resumeUrl = saved;
  if (saved) {
    var savedPath = normalizePath(saved);
    var savedEntry = chapters[savedPath];
    var savedLi = getListItemByUrl(saved);
    var isCompleted = !!(savedEntry && savedEntry.completed);
    if (!isCompleted && state && state.lastUrl && normalizePath(state.lastUrl) === savedPath) {
      isCompleted = !!state.completed;
    }
    if (isCompleted && savedLi) {
      var nextLi = getNextListItem(savedLi);
      if (nextLi) {
        resumeUrl = nextLi.dataset.url || (nextLi.querySelector('a') && nextLi.querySelector('a').getAttribute('href')) || saved;
      }
    }
    renderContinue(resumeUrl);
  }

  if (!saved && startBtn && continueBtn) {
    continueBtn.href = startBtn.getAttribute('href');
    continueBtn.textContent = 'Continue';
    continueBtn.style.display = 'inline-block';
  }

  if (!list) return;
  var savedPath = normalizePath(saved);
  list.querySelectorAll('li').forEach(function(li) {
    var path = normalizePath(li.dataset.url);
    var entry = chapters[path];
    if (savedPath && path && path === savedPath) li.classList.add('last-read');
    if (!entry) return;
    if (entry.completed) li.classList.add('completed');
  });
})();

// Filter chapters
(function() {
  var q = document.getElementById('chapterSearch');
  var list = document.getElementById('chapterList');
  if (!q || !list) return;

  function cleanChapterTitle(text) {
    var value = String(text || '').trim();
    // Strip duplicated leading chapter labels like:
    // "Chapter 12", "Chapter 12: Title", "Chapter 12 - Title"
    return value.replace(/^\s*chapter\s+\d+\s*[:.\-–—]*\s*/i, '').trim();
  }

  list.querySelectorAll('li').forEach(function(li) {
    var titleNode = li.querySelector('.chapter-title');
    if (!titleNode) return;
    var cleaned = cleanChapterTitle(titleNode.textContent);
    if (cleaned) titleNode.textContent = cleaned;
    li.dataset.title = cleaned.toLowerCase();
  });

  q.addEventListener('input', function() {
    var v = q.value.trim().toLowerCase();
    list.querySelectorAll('li').forEach(function(li) {
      var hit = !v || li.dataset.title.includes(v) || ('chapter '+li.dataset.no).includes(v);
      li.style.display = hit ? '' : 'none';
    });
  });
})();

// Related novels list from /novel/index.html
(function() {
  var slug = (document.body && document.body.dataset && document.body.dataset.novelSlug) || '';
  var section = document.getElementById('relatedNovelsSection');
  var summary = document.getElementById('relatedNovelsSummary');
  var list = document.getElementById('relatedNovelsList');
  var heroMeta = document.querySelector('.novel-hero .novel-meta');
  var unlockedKey = 'site:novels-unlocked';
  var indexUrl = "{{ '/novel/index.html' | relative_url }}";

  if (!slug || !section || !summary || !list || !window.fetch || !window.DOMParser) return;

  function clean(value) {
    return String(value || '').trim();
  }

  function normalizeSlug(value) {
    return clean(value).toLowerCase().replace(/[^a-z0-9-]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
  }

  function slugFromUrl(url) {
    var s = clean(url);
    if (!s) return '';
    var m = s.match(/\/novel\/([^\/?#]+)(?:\/|\/index\.html)?(?:[?#].*)?$/i);
    return m ? normalizeSlug(m[1]) : '';
  }

  function titleCase(value) {
    return clean(value)
      .split(/[\s_-]+/)
      .filter(Boolean)
      .map(function(word) { return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase(); })
      .join(' ');
  }

  function normalizeRelation(value) {
    var token = clean(value).toLowerCase().replace(/[^a-z]+/g, '');
    if (!token) return '';
    if (token === 'spinoff') return 'spin-off';
    if (token === 'prequel' || token === 'sequel' || token === 'companion' || token === 'original') return token;
    return '';
  }

  function relationLabel(value) {
    var key = normalizeRelation(value);
    if (!key) return '';
    if (key === 'spin-off') return 'Spin-off';
    return key.charAt(0).toUpperCase() + key.slice(1);
  }

  function inverseRelation(value) {
    var key = normalizeRelation(value);
    if (key === 'prequel') return 'sequel';
    if (key === 'sequel') return 'prequel';
    if (key === 'spin-off') return 'spin-off';
    if (key === 'companion') return 'companion';
    if (key === 'original') return 'original';
    return '';
  }

  function parseSeriesLabel(card, fallbackSeriesId) {
    var badge = card.querySelector('.novel-meta .badge[title^="Series:"]');
    if (badge) {
      var text = clean(badge.textContent);
      if (text) return text;
      var title = clean(badge.getAttribute('title'));
      var m = title.match(/^Series:\s*(.+)$/i);
      if (m && m[1]) return clean(m[1]);
    }
    return fallbackSeriesId ? titleCase(fallbackSeriesId) : '';
  }

  function parseOrder(raw) {
    var n = parseInt(clean(raw), 10);
    return Number.isFinite(n) ? n : Number.MAX_SAFE_INTEGER;
  }

  function cardTitle(card) {
    var titleNode = card.querySelector('.novel-title');
    var titleText = clean(titleNode ? titleNode.textContent : '');
    if (titleText) return titleText;
    var raw = clean(card.getAttribute('data-title'));
    return raw ? titleCase(raw) : '';
  }

  function captureAttrs(node, keys) {
    var attrs = {};
    if (!node) return attrs;
    keys.forEach(function(key) {
      var value = clean(node.getAttribute(key));
      if (value) attrs[key] = value;
    });
    return attrs;
  }

  function parseCover(card) {
    var picture = card.querySelector('picture');
    if (picture) {
      var sources = [];
      picture.querySelectorAll('source').forEach(function(sourceNode) {
        var sourceAttrs = captureAttrs(sourceNode, ['type', 'srcset', 'sizes', 'media']);
        if (Object.keys(sourceAttrs).length) sources.push(sourceAttrs);
      });
      var imgAttrs = captureAttrs(picture.querySelector('img'), ['src', 'srcset', 'sizes']);
      if (imgAttrs.src || imgAttrs.srcset || sources.length) {
        return { kind: 'picture', sources: sources, img: imgAttrs };
      }
    }
    var imgAttrsFallback = captureAttrs(card.querySelector('img'), ['src', 'srcset', 'sizes']);
    if (imgAttrsFallback.src || imgAttrsFallback.srcset) {
      return { kind: 'img', img: imgAttrsFallback };
    }
    return null;
  }

  function fallbackSrcFromSrcset(srcset) {
    var raw = clean(srcset);
    if (!raw) return '';
    var first = raw.split(',')[0] || '';
    var token = clean(first.split(' ')[0]);
    return token;
  }

  function buildCoverElement(cover, title) {
    var wrap = document.createElement('span');
    wrap.className = 'related-cover-wrap';
    var altText = title ? (title + ' cover art') : 'Novel cover art';
    if (!cover) return wrap;

    if (cover.kind === 'picture') {
      var picture = document.createElement('picture');
      (cover.sources || []).forEach(function(sourceInfo) {
        var source = document.createElement('source');
        Object.keys(sourceInfo).forEach(function(key) {
          source.setAttribute(key, sourceInfo[key]);
        });
        picture.appendChild(source);
      });
      var pictureImg = document.createElement('img');
      if (cover.img && cover.img.src) pictureImg.src = cover.img.src;
      if (cover.img && cover.img.srcset) pictureImg.srcset = cover.img.srcset;
      if (cover.img && cover.img.sizes) pictureImg.sizes = cover.img.sizes;
      if (!pictureImg.src && pictureImg.srcset) {
        var derivedSrc = fallbackSrcFromSrcset(pictureImg.srcset);
        if (derivedSrc) pictureImg.src = derivedSrc;
      }
      pictureImg.alt = altText;
      pictureImg.decoding = 'async';
      pictureImg.loading = 'lazy';
      picture.appendChild(pictureImg);
      wrap.appendChild(picture);
      return wrap;
    }

    var img = document.createElement('img');
    if (cover.img && cover.img.src) img.src = cover.img.src;
    if (cover.img && cover.img.srcset) img.srcset = cover.img.srcset;
    if (cover.img && cover.img.sizes) img.sizes = cover.img.sizes;
    if (!img.src && img.srcset) {
      var fallbackSrc = fallbackSrcFromSrcset(img.srcset);
      if (fallbackSrc) img.src = fallbackSrc;
    }
    img.alt = altText;
    img.decoding = 'async';
    img.loading = 'lazy';
    wrap.appendChild(img);
    return wrap;
  }

  function parseCard(card) {
    var anchor = card.querySelector('a[href]');
    var href = anchor ? clean(anchor.getAttribute('href')) : '';
    var cardSlug = slugFromUrl(href);
    var seriesId = clean(card.getAttribute('data-series'));

    return {
      slug: cardSlug,
      url: href,
      title: cardTitle(card),
      seriesId: seriesId,
      seriesLabel: parseSeriesLabel(card, seriesId),
      cover: parseCover(card),
      status: clean(card.getAttribute('data-status')).toLowerCase(),
      order: parseOrder(card.getAttribute('data-order')),
      relationType: normalizeRelation(card.getAttribute('data-relation')),
      relatedTo: normalizeSlug(card.getAttribute('data-related-to')),
      hidden: clean(card.getAttribute('data-hidden')).toLowerCase() === 'true'
    };
  }

  function isDirectRelation(current, candidate) {
    if (!current || !candidate) return false;
    return (candidate.relatedTo && candidate.relatedTo === current.slug) ||
      (current.relatedTo && current.relatedTo === candidate.slug);
  }

  function relationToCurrent(current, candidate) {
    if (!current || !candidate) return '';
    if (candidate.relatedTo && candidate.relatedTo === current.slug && candidate.relationType) {
      return candidate.relationType;
    }
    if (current.relatedTo && current.relatedTo === candidate.slug && current.relationType) {
      return inverseRelation(current.relationType);
    }
    if (current.seriesId && candidate.seriesId && current.seriesId === candidate.seriesId) {
      return 'same-series';
    }
    return '';
  }

  function createBadge(text, className) {
    var el = document.createElement('span');
    el.className = 'related-badge' + (className ? (' ' + className) : '');
    el.textContent = text;
    return el;
  }

  function createHeroRelationshipBadge(text, titleText) {
    var badge = document.createElement('span');
    badge.className = 'badge js-relationship-badge';
    badge.textContent = text;
    if (titleText) badge.title = titleText;
    return badge;
  }

  function mountHeroRelationshipBadges(current, bySlug) {
    if (!heroMeta || !current) return;

    Array.prototype.slice.call(heroMeta.querySelectorAll('.js-relationship-badge')).forEach(function(node) {
      node.remove();
    });

    var badges = [];
    if (current.seriesLabel) {
      badges.push(createHeroRelationshipBadge(current.seriesLabel, 'Series: ' + current.seriesLabel));
    }
    if (Number.isFinite(current.order) && current.order < Number.MAX_SAFE_INTEGER) {
      badges.push(createHeroRelationshipBadge('Book ' + current.order, 'Recommended reading order'));
    }
    if (current.relationType) {
      var label = relationLabel(current.relationType);
      if (label) {
        var relationTitle = label;
        if (current.relatedTo) {
          var relatedNovel = bySlug[current.relatedTo];
          var relatedLabel = relatedNovel && relatedNovel.title
            ? relatedNovel.title
            : titleCase(String(current.relatedTo).replace(/-/g, ' '));
          relationTitle = label + ' to ' + relatedLabel;
        }
        badges.push(createHeroRelationshipBadge(label, relationTitle));
      }
    }

    if (!badges.length) return;

    var chapterBadge = null;
    Array.prototype.slice.call(heroMeta.querySelectorAll('.badge')).forEach(function(node) {
      if (!chapterBadge && /chapters\s*:/i.test(String(node.textContent || ''))) {
        chapterBadge = node;
      }
    });

    var insertBeforeNode = chapterBadge ? chapterBadge.nextSibling : null;
    badges.forEach(function(node) {
      if (insertBeforeNode) {
        heroMeta.insertBefore(node, insertBeforeNode);
      } else {
        heroMeta.appendChild(node);
      }
    });
  }

  fetch(indexUrl, { credentials: 'same-origin' })
    .then(function(resp) {
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      return resp.text();
    })
    .then(function(html) {
      var doc = new DOMParser().parseFromString(html, 'text/html');
      var cards = Array.prototype.slice.call(doc.querySelectorAll('.novel-card'));
      if (!cards.length) return;

      var bySlug = {};
      cards.forEach(function(card) {
        var data = parseCard(card);
        if (data.slug) bySlug[data.slug] = data;
      });

      var current = bySlug[normalizeSlug(slug)];
      if (!current) return;
      mountHeroRelationshipBadges(current, bySlug);

      var unlocked = localStorage.getItem(unlockedKey) === 'true';
      var related = Object.keys(bySlug)
        .map(function(key) { return bySlug[key]; })
        .filter(function(item) {
          if (!item || item.slug === current.slug) return false;
          if (item.hidden && !unlocked) return false;
          var sameSeries = current.seriesId && item.seriesId && current.seriesId === item.seriesId;
          return sameSeries || isDirectRelation(current, item);
        });

      if (!related.length) return;

      related.sort(function(a, b) {
        var aSameSeries = !!(current.seriesId && a.seriesId === current.seriesId);
        var bSameSeries = !!(current.seriesId && b.seriesId === current.seriesId);
        if (aSameSeries !== bSameSeries) return aSameSeries ? -1 : 1;
        if (a.order !== b.order) return a.order - b.order;
        return a.title.localeCompare(b.title);
      });

      summary.textContent = related.length + ' related novel' + (related.length === 1 ? '' : 's') + ' found.';

      related.forEach(function(item) {
        var li = document.createElement('li');
        var link = document.createElement('a');
        link.href = item.url;
        link.className = 'related-card';
        link.setAttribute('aria-label', item.title);
        link.appendChild(buildCoverElement(item.cover, item.title));

        var body = document.createElement('div');
        body.className = 'related-body';

        var title = document.createElement('span');
        title.className = 'related-title';
        title.textContent = item.title;
        body.appendChild(title);

        var meta = document.createElement('span');
        meta.className = 'related-meta';

        var relation = relationToCurrent(current, item);
        if (relation) {
          var relationText = relation === 'same-series' ? 'Same series' : relationLabel(relation);
          if (relationText) meta.appendChild(createBadge(relationText, 'relation'));
        }
        if (item.seriesLabel) meta.appendChild(createBadge(item.seriesLabel, 'series'));
        if (Number.isFinite(item.order) && item.order < Number.MAX_SAFE_INTEGER) {
          meta.appendChild(createBadge('Book ' + item.order, 'order'));
        }
        if (item.status === 'complete') meta.appendChild(createBadge('Complete', 'complete'));
        if (item.status === 'incomplete') meta.appendChild(createBadge('Incomplete', 'incomplete'));

        if (meta.childNodes.length) body.appendChild(meta);
        link.appendChild(body);
        li.appendChild(link);
        list.appendChild(li);
      });

      section.hidden = false;
    })
    .catch(function() {
      section.hidden = true;
    });
})();

// Horizontal wheel support for related novel cards
(function() {
  var strip = document.getElementById('relatedNovelsList');
  if (!strip) return;
  strip.addEventListener('wheel', function(event) {
    if (strip.scrollWidth <= strip.clientWidth) return;
    if (Math.abs(event.deltaY) <= Math.abs(event.deltaX)) return;
    strip.scrollLeft += event.deltaY;
    event.preventDefault();
  }, { passive: false });
})();

// Theme toggle (light/dark), remembers choice and updates theme-color
(function () {
  var root = document.documentElement;
  var btn = document.getElementById("themeToggle");
  var storageKey = "site:theme";

  function isDarkNow() {
    var forced = root.getAttribute("data-theme");
    if (forced) return forced === "dark";
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  }

  function icon() {
    btn.textContent = isDarkNow() ? "☀️" : "🌙";
    btn.setAttribute(
      "aria-label",
      isDarkNow() ? "Switch to light theme" : "Switch to dark theme"
    );
  }

  function updateThemeColor() {
    var m = document.querySelector('meta[name="theme-color"]');
    if (!m) {
      m = document.createElement("meta");
      m.name = "theme-color";
      document.head.appendChild(m);
    }
    var bg = getComputedStyle(root).getPropertyValue("--bg").trim() || "#ffffff";
    m.setAttribute("content", bg);
  }

  function apply(saved) {
    if (saved === "light" || saved === "dark") {
      root.setAttribute("data-theme", saved);
    } else {
      root.removeAttribute("data-theme");
    }
    icon();
    updateThemeColor();
  }

  var saved = localStorage.getItem(storageKey);
  apply(saved);

  btn.addEventListener("click", function () {
    var cur = localStorage.getItem(storageKey);
    var next = cur === "dark" ? "light" : "dark";
    localStorage.setItem(storageKey, next);
    apply(next);
  });

  if (!saved && window.matchMedia) {
    var mq = window.matchMedia("(prefers-color-scheme: dark)");
    mq.addEventListener("change", function () {
      apply(null);
    });
  }
})();
</script>
</body>
</html>

