<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {% assign raw_novel_title = page.Title | default: page.title | default: page.novel %}
    {% assign novel_display_title = raw_novel_title | replace: ' - Chapters', '' | strip %}
    {% if novel_display_title == '' or raw_novel_title contains 'Chapters' %}
      {% assign _novel_words = page.novel | replace: '-', ' ' | replace: '_', ' ' | split: ' ' %}
      {% capture _novel_title_from_slug %}{% for w in _novel_words %}{% if w != '' %}{{ w | capitalize }}{% unless forloop.last %} {% endunless %}{% endif %}{% endfor %}{% endcapture %}
      {% assign novel_display_title = _novel_title_from_slug | strip %}
    {% endif %}
    <title>{{ novel_display_title }} · {{ site.title }}</title>
    <meta name="theme-color" content="#ffffff" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
:root{
  /* light default */
  --bg:#ffffff;
  --text:#111111;
  --muted:#444444;
  --card:#ffffff;
  --border:#e6e6e6;
  --link:#111111;
  --btn-bg:#111111; --btn-text:#ffffff; --btn-brd:#111111;

  --pill:#eef; --pill-brd:#dbe;
  --pill-ok:#e8f7ec; --pill-ok-brd:#c9ebd5;
  --pill-wip:#fff5e6; --pill-wip-brd:#ffe0b3;

  color-scheme: light dark;
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b0e13;
    --text:#e7eaf0;
    --muted:#a8b2c1;
    --card:#11151d;
    --border:#253043;
    --link:#e7eaf0;
    --btn-bg:#e7eaf0; --btn-text:#0b0e13; --btn-brd:#e7eaf0;

    --pill:#253043; --pill-brd:#32405a;
    --pill-ok:#15351f; --pill-ok-brd:#275d3b;
    --pill-wip:#3b2d17; --pill-wip-brd:#5c4321;
  }
}

/* Manual override has priority over system */
:root[data-theme="light"]{
  --bg:#ffffff; --text:#111111; --muted:#444444; --card:#ffffff; --border:#e6e6e6; --link:#111111;
  --btn-bg:#111111; --btn-text:#ffffff; --btn-brd:#111111;
  --pill:#eef; --pill-brd:#dbe; --pill-ok:#e8f7ec; --pill-ok-brd:#c9ebd5; --pill-wip:#fff5e6; --pill-wip-brd:#ffe0b3;
}
:root[data-theme="dark"]{
  --bg:#0b0e13; --text:#e7eaf0; --muted:#a8b2c1; --card:#11151d; --border:#253043; --link:#e7eaf0;
  --btn-bg:#e7eaf0; --btn-text:#0b0e13; --btn-brd:#e7eaf0;
  --pill:#253043; --pill-brd:#32405a; --pill-ok:#15351f; --pill-ok-brd:#275d3b; --pill-wip:#3b2d17; --pill-wip-brd:#5c4321;
}

body{background:var(--bg); color:var(--text); margin:0; font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif}
a{color:var(--link); text-decoration:none}
a:hover{text-decoration:underline}

/* Header styles */
.site-header{position:sticky;top:0;z-index:10;background:color-mix(in oklab, var(--bg), var(--card) 40%);border-bottom:1px solid var(--border);backdrop-filter:blur(8px);padding:.85rem 1.25rem;font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif}
.header-content{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.brand{font-weight:600;font-size:1.05rem;font-family:"Merriweather",serif}
.header-right{display:flex;align-items:center;gap:1rem}
.crumbs{display:flex;align-items:center;gap:.35rem;font-size:.9rem;color:var(--muted)}
.crumbs a{color:var(--muted)}
.crumbs a:hover{color:var(--text);text-decoration:none}

/* Main container */
.container{max-width:1100px;margin:0 auto;padding:0 1.25rem}

.novel-hero{display:grid;grid-template-columns:120px 1fr;gap:1rem;align-items:center;margin:1.5rem 0;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
.novel-hero img{width:120px;height:180px;object-fit:cover;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,.12)}
@media (min-width:720px){.novel-hero{grid-template-columns:180px 1fr}.novel-hero img{width:180px;height:270px}}
.novel-title{margin:0;font-size:clamp(1.4rem,2.5vw,2rem);line-height:1.15}
.novel-meta{display:flex;gap:.5rem;flex-wrap:wrap;margin:.25rem 0 .5rem}
.badge{font-size:.8rem;padding:.1rem .35rem;border-radius:999px;background:var(--pill);border:1px solid var(--pill-brd);white-space:nowrap}
.badge.complete{background:var(--pill-ok);border-color:var(--pill-ok-brd)}
.badge.incomplete{background:var(--pill-wip);border-color:var(--pill-wip-brd)}
.novel-actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.6rem 0 0}
.novel-actions a{display:inline-block;padding:.6rem .9rem;border-radius:8px;text-decoration:none;border:1px solid var(--border);background:var(--card);color:var(--link)}
.novel-actions a.primary{background:var(--btn-bg);color:var(--btn-text);border-color:var(--btn-brd)}
.novel-actions a:hover{filter:brightness(1.05)}
.novel-blurb{margin:.5rem 0 0;color:var(--muted);max-width:65ch}
.chapter-tools{display:flex;gap:.6rem;align-items:center;margin:1.5rem 0 .6rem}
.chapter-tools input[type=search]{max-width:420px;width:100%;padding:.55rem .7rem;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text)}
.chapter-list{list-style:none;padding:0;margin:0;display:grid;gap:.4rem}
.chapter-list li a{display:flex;gap:.6rem;align-items:center;padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:inherit;background:var(--card)}
.chapter-list li a:hover{background:color-mix(in oklab, var(--card), var(--text) 6%)}
.chapter-list li.last-read a{border-color:color-mix(in oklab, var(--btn-brd), var(--border) 45%);box-shadow:0 0 0 1px color-mix(in oklab, var(--btn-brd), transparent 65%) inset}
.chapter-list li.completed a{opacity:.58;filter:saturate(.15)}
.chapter-list li.completed a:hover{opacity:.78}
.chapter-no{font-variant-numeric:tabular-nums;color:var(--muted);min-width:4.5rem}
.chapter-title{flex:1;min-width:0}
.small-note{font-size:.85rem;color:var(--muted)}
/* theme toggle */
.theme-toggle{margin-left:auto;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:8px;padding:.45rem .6rem;cursor:pointer;font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif}
.theme-toggle:hover{filter:brightness(1.05)}
</style>
</head>
<body data-novel-slug="{{ page.novel | escape }}">
{% assign novel_slug = page.novel %}
{% assign cover_url = page.cover | default: '/images/' | append: novel_slug | append: '-cover.png' %}
{% assign status = page.status | default: 'Incomplete' %}
{% assign blurb = page.blurb %}
{% assign pathprefix = '/novel/' | append: novel_slug | append: '/' %}
{% assign items = site.pages | where_exp: 'p', 'p.url contains pathprefix' | where_exp: 'p', 'p.name != "index.md"' | sort: 'order' %}

<!-- optional theme-color for mobile -->
<meta name="theme-color" content="#ffffff">

<header class="site-header">
  <div class="header-content">
    <a class="brand" href="{{ "/" | relative_url }}">{{ site.title }}</a>
    <div class="header-right">
      <nav class="crumbs">
        <a href="/novel/">All Novels</a>
      </nav>
      <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle theme">🌙</button>
    </div>
  </div>
</header>

<div class="container">
<div class="novel-hero">
  <img src="{{ cover_url | relative_url }}" alt="{{ novel_display_title }}">
  <div>
    <h1 class="novel-title">{{ novel_display_title }}</h1>
    <div class="novel-meta">
      <span class="badge {{ status | downcase }}">{{ status }}</span>
      <span class="badge">Chapters: {{ items | size }}</span>
    </div>
    {% if blurb %}<p class="novel-blurb">{{ blurb }}</p>{% endif %}

    <div class="novel-actions">
      {% assign first = items | first %}
      {% if first %}
        <a class="primary" id="startReading" href="{{ first.url | relative_url }}">Start reading</a>
      {% endif %}
      <a id="continueReading" href="#" style="display:none">Continue</a>
      <a href="/novel/">Back to all novels</a>
    </div>
  </div>
</div>

<div class="chapter-tools">
  <input id="chapterSearch" type="search" placeholder="Search chapters… (title or number)">
  <span class="small-note">Tip: we’ll remember your last chapter.</span>
</div>

<ul id="chapterList" class="chapter-list">
  {% for ch in items %}
    <li data-title="{{ ch.Title | default: ch.title | downcase }}" data-no="{{ ch.order }}" data-url="{{ ch.url | relative_url }}">
      <a href="{{ ch.url | relative_url }}">
        <span class="chapter-no">Chapter {{ ch.order }}</span>
        <span class="chapter-title">{{ ch.Title | default: ch.title }}</span>
      </a>
    </li>
  {% endfor %}
</ul>

</div>
<script>
// Continue Reading + chapter progress UI (per novel)
(function() {
  var slug = (document.body && document.body.dataset && document.body.dataset.novelSlug) || '';
  var lastUrlKey = 'novel:'+slug+':lastUrl';
  var stateKey = 'novel:'+slug+':state';
  var chaptersKey = 'novel:'+slug+':chapters';
  var continueBtn = document.getElementById('continueReading');
  var startBtn = document.getElementById('startReading');
  var list = document.getElementById('chapterList');
  var state = {};
  var chapters = {};
  var saved = '';

  function safeParse(raw, fallback) {
    if (!raw) return fallback;
    try { return JSON.parse(raw); } catch (e) { return fallback; }
  }

  function normalizePath(url) {
    if (!url) return '';
    var s = String(url);
    try {
      if (/^https?:\/\//i.test(s)) s = new URL(s).pathname;
    } catch (e) {}
    s = s.replace(/\/index\.html$/i, '/');
    if (s.length > 1) s = s.replace(/\/+$/, '');
    return s;
  }

  function getListItemByUrl(url) {
    if (!list) return null;
    var target = normalizePath(url);
    if (!target) return null;
    var match = null;
    list.querySelectorAll('li').forEach(function(li) {
      if (!match && normalizePath(li.dataset.url) === target) match = li;
    });
    return match;
  }

  function getNextListItem(li) {
    if (!li) return null;
    var next = li.nextElementSibling;
    while (next && next.tagName !== 'LI') next = next.nextElementSibling;
    return next || null;
  }

  function renderContinue(url) {
    if (!continueBtn || !url) return;
    var li = getListItemByUrl(url);
    var chapterNo = li ? li.dataset.no : ((state && state.lastOrder != null) ? state.lastOrder : '');
    var label = chapterNo ? ('Continue Chapter ' + chapterNo) : 'Continue';
    continueBtn.href = url;
    continueBtn.textContent = label;
    continueBtn.setAttribute('aria-label', label);
    continueBtn.style.display = 'inline-block';
  }

  try {
    state = safeParse(localStorage.getItem(stateKey), {}) || {};
    var rawChapters = safeParse(localStorage.getItem(chaptersKey), {}) || {};
    Object.keys(rawChapters).forEach(function(k) {
      chapters[normalizePath(k)] = rawChapters[k];
    });
    saved = (state && state.lastUrl) || localStorage.getItem(lastUrlKey) || '';
  } catch (e) {
    state = {};
    chapters = {};
    saved = '';
  }

  var resumeUrl = saved;
  if (saved) {
    var savedPath = normalizePath(saved);
    var savedEntry = chapters[savedPath];
    var savedLi = getListItemByUrl(saved);
    var isCompleted = !!(savedEntry && savedEntry.completed);
    if (!isCompleted && state && state.lastUrl && normalizePath(state.lastUrl) === savedPath) {
      isCompleted = !!state.completed;
    }
    if (isCompleted && savedLi) {
      var nextLi = getNextListItem(savedLi);
      if (nextLi) {
        resumeUrl = nextLi.dataset.url || (nextLi.querySelector('a') && nextLi.querySelector('a').getAttribute('href')) || saved;
      }
    }
    renderContinue(resumeUrl);
  }

  if (!saved && startBtn && continueBtn) {
    continueBtn.href = startBtn.getAttribute('href');
    continueBtn.textContent = 'Continue';
    continueBtn.style.display = 'inline-block';
  }

  if (!list) return;
  var savedPath = normalizePath(saved);
  list.querySelectorAll('li').forEach(function(li) {
    var path = normalizePath(li.dataset.url);
    var entry = chapters[path];
    if (savedPath && path && path === savedPath) li.classList.add('last-read');
    if (!entry) return;
    if (entry.completed) li.classList.add('completed');
  });
})();

// Filter chapters
(function() {
  var q = document.getElementById('chapterSearch');
  var list = document.getElementById('chapterList');
  if (!q || !list) return;
  q.addEventListener('input', function() {
    var v = q.value.trim().toLowerCase();
    list.querySelectorAll('li').forEach(function(li) {
      var hit = !v || li.dataset.title.includes(v) || ('chapter '+li.dataset.no).includes(v);
      li.style.display = hit ? '' : 'none';
    });
  });
})();

// Theme toggle (light/dark), remembers choice and updates theme-color
(function () {
  var root = document.documentElement;
  var btn = document.getElementById("themeToggle");
  var storageKey = "site:theme";

  function isDarkNow() {
    var forced = root.getAttribute("data-theme");
    if (forced) return forced === "dark";
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  }

  function icon() {
    btn.textContent = isDarkNow() ? "☀️" : "🌙";
    btn.setAttribute(
      "aria-label",
      isDarkNow() ? "Switch to light theme" : "Switch to dark theme"
    );
  }

  function updateThemeColor() {
    var m = document.querySelector('meta[name="theme-color"]');
    if (!m) {
      m = document.createElement("meta");
      m.name = "theme-color";
      document.head.appendChild(m);
    }
    var bg = getComputedStyle(root).getPropertyValue("--bg").trim() || "#ffffff";
    m.setAttribute("content", bg);
  }

  function apply(saved) {
    if (saved === "light" || saved === "dark") {
      root.setAttribute("data-theme", saved);
    } else {
      root.removeAttribute("data-theme");
    }
    icon();
    updateThemeColor();
  }

  var saved = localStorage.getItem(storageKey);
  apply(saved);

  btn.addEventListener("click", function () {
    var cur = localStorage.getItem(storageKey);
    var next = cur === "dark" ? "light" : "dark";
    localStorage.setItem(storageKey, next);
    apply(next);
  });

  if (!saved && window.matchMedia) {
    var mq = window.matchMedia("(prefers-color-scheme: dark)");
    mq.addEventListener("change", function () {
      apply(null);
    });
  }
})();
</script>
</body>
</html>

