<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page.Title | default: page.title }} · {{ site.title }}</title>
    <link rel="stylesheet" href="{{ "/assets/css/reader.css" | relative_url }}">
    <style>
    article, .markdown-body { 
      font-size: clamp(1rem, 2.8vw, 1.125rem);
      line-height: 1.7;
    }
    .markdown-body p { margin: 0 0 1rem; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { line-height: 1.25; margin-top: 1.4em; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <a class="brand" href="{{ "/" | relative_url }}">{{ site.title }}</a>
      <nav class="crumbs">
        <a href="{{ "/novel/" | relative_url }}">All Novels</a>
        <span>/</span>
        <a href="{{ "/novel/" | append: page.novel | append: "/" | relative_url }}">
          {{ page.novel | replace: '-', ' ' | capitalize }}
        </a>
      </nav>
    </header>

    <main class="reader">
      <article>
        <h1>{{ page.Title | default: page.title }}</h1>
        {% if page.order %}<div class="chapter-meta">Chapter {{ page.order }}</div>{% endif %}
        {{ content }}
      </article>

{% comment %}Build ordered list of chapter pages in this novel{% endcomment %}
{% assign pathprefix = '/novel/' | append: page.novel | append: '/' %}
{% assign siblings = site.pages
  | where_exp: 'p', 'p.url contains pathprefix'
  | where_exp: 'p', 'p.name != "index.md"'
  | sort: 'order' %}

{% comment %}Find current page index{% endcomment %}
{% assign idx = -1 %}
{% for c in siblings %}
  {% if c.url == page.url %}
    {% assign idx = forloop.index0 %}
  {% endif %}
{% endfor %}
{% assign count = siblings | size %}

{% comment %}Compute prev/next indices BEFORE indexing the array{% endcomment %}
{% assign prev_index = idx | minus: 1 %}
{% assign next_index = idx | plus: 1 %}

<nav class="pager">
  {% if prev_index >= 0 %}
    {% assign prev = siblings[prev_index] %}
    <a class="btn prev" rel="prev" href="{{ prev.url | relative_url }}">← Prev</a>
  {% else %}
    <span></span>
  {% endif %}

  {% assign toc = site.pages | where_exp: 'p', 'p.url == pathprefix' | first %}
  {% assign toc_url = toc.url | default: pathprefix | append: 'index.html' %}
  {% if page.url == toc_url %}
    <span class="btn toc" aria-current="page">Chapters</span>
  {% else %}
    <a class="btn toc" href="{{ toc_url | relative_url }}">Chapters</a>
  {% endif %}

  {% if next_index < count and next_index >= 0 %}
    {% assign next = siblings[next_index] %}
    <a class="btn next" rel="next" href="{{ next.url | relative_url }}">Next →</a>
  {% else %}
    <span></span>
  {% endif %}
</nav>
    </main>
    <script>
    (function() {
      try {
        var novel = '{{ page.novel | escape }}';
        var key = 'novel:'+novel+':lastUrl';
        localStorage.setItem(key, location.pathname);
      } catch(e) {}
    })();
    </script>
    <script src="{{ "/assets/js/chapter.js" | relative_url }}" defer></script>
  </body>
</html>
