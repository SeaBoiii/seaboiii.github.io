<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page.Title | default: page.title }} · {{ site.title }}</title>
    <meta name="theme-color" content="#ffffff" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --card: #ffffff;
        --border: #e6e6e6;
        --link: #111111;
        --btn-bg: #111111;
        --btn-text: #ffffff;
        --btn-brd: #111111;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        --quote-bar: #b9c0cb;
        --quote-bg: #f4f6f8;
        --quote-text: #111111;
        --quote-strong: #0b0d10;
        color-scheme: light dark;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0e13;
          --text: #e7eaf0;
          --muted: #a8b2c1;
          --card: #11151d;
          --border: #253043;
          --link: #e7eaf0;
          --btn-bg: #e7eaf0;
          --btn-text: #0b0e13;
          --btn-brd: #e7eaf0;
          --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
          --quote-bar: #5a6474;
          --quote-bg: #0f141c;
          --quote-text: #eef2f8;
          --quote-strong: #ffffff;
        }
      }

      :root[data-theme="light"] {
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --card: #ffffff;
        --border: #e6e6e6;
        --link: #111111;
        --btn-bg: #111111;
        --btn-text: #ffffff;
        --btn-brd: #111111;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        --quote-bar: #b9c0cb;
        --quote-bg: #f4f6f8;
        --quote-text: #111111;
        --quote-strong: #0b0d10;
      }

      :root[data-theme="dark"] {
        --bg: #0b0e13;
        --text: #e7eaf0;
        --muted: #a8b2c1;
        --card: #11151d;
        --border: #253043;
        --link: #e7eaf0;
        --btn-bg: #e7eaf0;
        --btn-text: #0b0e13;
        --btn-brd: #e7eaf0;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        --quote-bar: #5a6474;
        --quote-bg: #0f141c;
        --quote-text: #eef2f8;
        --quote-strong: #ffffff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        background: var(--bg);
        color: var(--text);
        transition: background 0.2s ease, color 0.2s ease;
      }

      a {
        color: var(--link);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .site-header {
        position: sticky;
        top: 0;
        z-index: 30;
        background: color-mix(in oklab, var(--bg), var(--card) 40%);
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(8px);
        padding: 0.85rem 1.25rem;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      }

      .read-progress {
        position: absolute;
        left: 0;
        right: 0;
        bottom: -1px;
        height: 3px;
        background: color-mix(in oklab, var(--border), transparent 45%);
        overflow: hidden;
      }

      .read-progress-fill {
        height: 100%;
        width: 100%;
        transform-origin: left center;
        transform: scaleX(0);
        background: var(--btn-bg);
        transition: transform 0.08s linear;
      }

      .header-content {
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .brand {
        font-weight: 600;
        font-size: 1.05rem;
        font-family: "Merriweather", serif;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .crumbs {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .crumbs a {
        color: var(--muted);
      }

      .crumbs a:hover {
        color: var(--text);
      }

      .theme-toggle {
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 8px;
        padding: 0.4rem 0.5rem;
        cursor: pointer;
        font-size: 0.9rem;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      }

      .theme-toggle:hover {
        filter: brightness(1.05);
      }

      .reader {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1.25rem 4rem;
      }

      article {
        font-size: clamp(1.05rem, 2.2vw, 1.15rem);
        line-height: 1.75;
      }

      article h1 {
        font-family: "Georgia", serif;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        line-height: 1.2;
        margin: 0 0 0.5rem;
        font-weight: 600;
      }

      .chapter-meta {
        color: var(--muted);
        font-size: 0.95rem;
        margin-bottom: 2rem;
        font-family: system-ui, -apple-system, sans-serif;
      }

      article p {
        margin: 0 0 1.25rem;
      }

      article p.journal-box {
        margin: 1.3rem 0 1.45rem;
        padding: 0.7rem 0.85rem;
        white-space: pre;
        overflow-x: auto;
        line-height: 1.22;
        font-size: 0.95rem;
        letter-spacing: 0;
        word-spacing: 0;
        tab-size: 2;
        font-kerning: none;
        font-variant-ligatures: none;
        font-feature-settings: "liga" 0, "calt" 0;
        font-family: "Cascadia Mono", "Consolas", "Courier New", "MS Gothic", monospace;
        color: var(--text);
        background: color-mix(in oklab, var(--card), var(--bg) 25%);
        border: 1px solid color-mix(in oklab, var(--border), transparent 15%);
        border-radius: 10px;
      }

      article p.journal-box em,
      article p.journal-box strong,
      article p.journal-box code {
        font-family: inherit;
      }

      article p.journal-box .journal-pad {
        display: inline-block;
      }

      article hr {
        border: 0;
        border-top: 1px solid color-mix(in oklab, var(--border), transparent 35%);
        width: min(34ch, 58%);
        margin: 2rem auto;
        opacity: 0.75;
      }

      article blockquote {
        margin: 1.1rem 0 1.35rem;
        padding: 0.35rem 0 0.35rem 0.95rem;
        border-left: 4px solid var(--quote-bar);
        color: var(--quote-text);
        background: var(--quote-bg);
        border-radius: 0 8px 8px 0;
      }

      article blockquote p {
        margin: 0 0 0.7rem;
      }

      article blockquote strong {
        color: var(--quote-strong);
      }

      article blockquote p:last-child {
        margin-bottom: 0;
      }

      article h2,
      article h3 {
        line-height: 1.3;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
      }

      .pager {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 0.75rem;
        margin-top: 2.25rem;
        padding: 0.85rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--card);
        box-shadow: var(--shadow);
        align-items: center;
      }

      .pager .btn {
        display: inline-block;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--card);
        color: var(--text);
        text-decoration: none;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .pager .btn:hover {
        background: var(--btn-bg);
        color: var(--btn-text);
        border-color: var(--btn-brd);
        text-decoration: none;
      }

      .pager .prev {
        justify-self: start;
      }

      .pager .next {
        justify-self: end;
      }

      .pager .toc {
        justify-self: center;
        font-weight: 600;
      }

      .pager .next {
        font-weight: 700;
        background: var(--btn-bg);
        color: var(--btn-text);
        border-color: var(--btn-brd);
      }

      .pager .next:hover {
        filter: brightness(1.06);
        text-decoration: none;
      }

      .pager .btn.disabled {
        opacity: 0.6;
        pointer-events: none;
      }

      .pager span:empty {
        visibility: hidden;
      }

      .chapter-complete {
        margin-top: 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.8rem;
        padding: 0.8rem 0.9rem;
        border: 1px solid color-mix(in oklab, var(--btn-brd), var(--border) 50%);
        border-radius: 12px;
        background: color-mix(in oklab, var(--card), var(--btn-bg) 4%);
        box-shadow: var(--shadow);
      }

      .chapter-complete-copy {
        display: grid;
        gap: 0.12rem;
        min-width: 0;
      }

      .chapter-complete-copy strong {
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 0.95rem;
      }

      .chapter-complete-copy span {
        color: var(--muted);
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.87rem;
      }

      .mobile-chapter-nav {
        display: none;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 25;
        border-top: 1px solid var(--border);
        background: color-mix(in oklab, var(--bg), var(--card) 35%);
        backdrop-filter: blur(8px);
      }

      .mobile-chapter-nav .inner {
        max-width: 800px;
        margin: 0 auto;
        padding: 0.5rem 0.9rem calc(0.5rem + env(safe-area-inset-bottom));
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 0.5rem;
        align-items: center;
      }

      .mobile-chapter-nav .m-btn {
        display: inline-block;
        text-align: center;
        text-decoration: none;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--card);
        color: var(--text);
        padding: 0.65rem 0.7rem;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.9rem;
        line-height: 1.15;
      }

      .mobile-chapter-nav .m-btn.prev {
        justify-self: start;
      }

      .mobile-chapter-nav .m-btn.toc {
        justify-self: center;
        font-weight: 600;
      }

      .mobile-chapter-nav .m-btn.next {
        justify-self: end;
        border-color: var(--btn-brd);
        background: var(--btn-bg);
        color: var(--btn-text);
        font-weight: 700;
      }

      .mobile-chapter-nav .m-btn.disabled {
        opacity: 0.55;
        pointer-events: none;
      }

      @media (max-width: 640px) {
        .reader {
          padding-bottom: 6.75rem;
        }

        .chapter-complete {
          flex-direction: column;
          align-items: stretch;
        }

        .pager {
          grid-template-columns: 1fr;
        }

        .pager .prev,
        .pager .next,
        .pager .toc {
          justify-self: stretch;
          text-align: center;
        }

        .mobile-chapter-nav {
          display: block;
        }
      }
    </style>
  </head>
  <body
    data-novel="{{ page.novel | escape }}"
    data-chapter-order="{{ page.order | default: '' }}"
    data-chapter-title="{{ page.Title | default: page.title | escape }}"
  >
    <header class="site-header">
      <div class="header-content">
        <a class="brand" href="{{ "/" | relative_url }}">{{ site.title }}</a>
        <div class="header-right">
          <nav class="crumbs">
            <a href="{{ "/novel/" | relative_url }}">All Novels</a>
            <span>/</span>
            <a href="{{ "/novel/" | append: page.novel | append: "/" | relative_url }}">
              {{ page.novel | replace: '-', ' ' | capitalize }}
            </a>
          </nav>
          <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle theme">🌙</button>
        </div>
      </div>
      <div class="read-progress" aria-hidden="true">
        <div id="readProgressBar" class="read-progress-fill"></div>
      </div>
    </header>

    <main class="reader">
      <article>
        <h1>{{ page.Title | default: page.title }}</h1>
        {% if page.order %}<div class="chapter-meta">Chapter {{ page.order }}</div>{% endif %}
        {{ content }}
      </article>

{% comment %}Build ordered list of chapter pages in this novel{% endcomment %}
{% assign pathprefix = '/novel/' | append: page.novel | append: '/' %}
{% assign siblings = site.pages
  | where_exp: 'p', 'p.url contains pathprefix'
  | where_exp: 'p', 'p.name != "index.md"'
  | sort: 'order' %}

{% comment %}Find current page index{% endcomment %}
{% assign idx = -1 %}
{% for c in siblings %}
  {% if c.url == page.url %}
    {% assign idx = forloop.index0 %}
  {% endif %}
{% endfor %}
{% assign count = siblings | size %}

{% comment %}Compute prev/next indices BEFORE indexing the array{% endcomment %}
{% assign prev_index = idx | minus: 1 %}
{% assign next_index = idx | plus: 1 %}
{% assign toc = site.pages | where_exp: 'p', 'p.url == pathprefix' | first %}
{% assign toc_url = toc.url | default: pathprefix | append: 'index.html' %}


<!--
<section id="chapterCompletionPanel" class="chapter-complete" hidden aria-live="polite">
  <div class="chapter-complete-copy">
    <strong id="chapterCompletionTitle">Chapter completed</strong>
    <span id="chapterCompletionText">Nice. Ready for the next chapter?</span>
  </div>
</section>
-->

<nav class="pager">
  {% if prev_index >= 0 %}
    {% assign prev = siblings[prev_index] %}
    <a class="btn prev" rel="prev" href="{{ prev.url | relative_url }}">Previous chapter</a>
  {% else %}
    <span></span>
  {% endif %}

  {% if page.url == toc_url %}
    <span class="btn toc" aria-current="page">Back to chapters</span>
  {% else %}
    <a class="btn toc" href="{{ toc_url | relative_url }}">Back to chapters</a>
  {% endif %}

  {% if next_index < count and next_index >= 0 %}
    {% assign next = siblings[next_index] %}
    <a class="btn next" rel="next" href="{{ next.url | relative_url }}">Next chapter</a>
  {% else %}
    <span class="btn next disabled" aria-disabled="true">End of novel</span>
  {% endif %}
</nav>
    </main>

    <nav class="mobile-chapter-nav" aria-label="Chapter navigation">
      <div class="inner">
        {% if prev_index >= 0 %}
          {% assign prev = siblings[prev_index] %}
          <a class="m-btn prev" href="{{ prev.url | relative_url }}">Prev</a>
        {% else %}
          <span class="m-btn prev disabled" aria-disabled="true">Prev</span>
        {% endif %}

        <a class="m-btn toc" href="{{ toc_url | relative_url }}">Chapters</a>

        {% if next_index < count and next_index >= 0 %}
          {% assign next = siblings[next_index] %}
          <a class="m-btn next" href="{{ next.url | relative_url }}">Next</a>
        {% else %}
          <span class="m-btn next disabled" aria-disabled="true">End</span>
        {% endif %}
      </div>
    </nav>

    <script>
      // Theme toggle (synced with rest of site)
      (function () {
        var root = document.documentElement;
        var btn = document.getElementById("themeToggle");
        var storageKey = "site:theme";

        function isDarkNow() {
          var forced = root.getAttribute("data-theme");
          if (forced) return forced === "dark";
          return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        }

        function icon() {
          btn.textContent = isDarkNow() ? "☀️" : "🌙";
          btn.setAttribute(
            "aria-label",
            isDarkNow() ? "Switch to light theme" : "Switch to dark theme"
          );
        }

        function updateThemeColor() {
          var m = document.querySelector('meta[name="theme-color"]');
          if (!m) {
            m = document.createElement("meta");
            m.name = "theme-color";
            document.head.appendChild(m);
          }
          var bg = getComputedStyle(root).getPropertyValue("--bg").trim() || "#ffffff";
          m.setAttribute("content", bg);
        }

        function apply(saved) {
          if (saved === "light" || saved === "dark") {
            root.setAttribute("data-theme", saved);
          } else {
            root.removeAttribute("data-theme");
          }
          icon();
          updateThemeColor();
        }

        var saved = localStorage.getItem(storageKey);
        apply(saved);

        btn.addEventListener("click", function () {
          var cur = localStorage.getItem(storageKey);
          var next = cur === "dark" ? "light" : "dark";
          localStorage.setItem(storageKey, next);
          apply(next);
        });

        if (!saved && window.matchMedia) {
          var mq = window.matchMedia("(prefers-color-scheme: dark)");
          mq.addEventListener("change", function () {
            apply(null);
          });
        }
      })();

      // Save + restore reading progress
      (function() {
        try {
          var bodyData = (document.body && document.body.dataset) || {};
          var novel = bodyData.novel || '';
          if (!novel) return;

          var chapterOrderRaw = bodyData.chapterOrder || '';
          var chapterOrder = (typeof chapterOrderRaw === 'number')
            ? chapterOrderRaw
            : parseInt(chapterOrderRaw, 10);
          if (!isFinite(chapterOrder)) chapterOrder = null;

          var chapterTitle = bodyData.chapterTitle || '';
          var path = location.pathname;
          var lastUrlKey = 'novel:'+novel+':lastUrl';
          var stateKey = 'novel:'+novel+':state';
          var chaptersKey = 'novel:'+novel+':chapters';
          var saveTimer = null;
          var restored = false;

          function clamp(n, min, max) {
            return Math.min(max, Math.max(min, n));
          }

          function safeParse(raw, fallback) {
            if (!raw) return fallback;
            try { return JSON.parse(raw); } catch (e) { return fallback; }
          }

          function docHeight() {
            var d = document.documentElement;
            var b = document.body;
            return Math.max(
              d ? d.scrollHeight : 0,
              d ? d.offsetHeight : 0,
              b ? b.scrollHeight : 0,
              b ? b.offsetHeight : 0
            );
          }

          function viewportHeight() {
            return window.innerHeight || (document.documentElement && document.documentElement.clientHeight) || 0;
          }

          function metrics() {
            var y = window.scrollY || window.pageYOffset || (document.documentElement && document.documentElement.scrollTop) || 0;
            var vh = viewportHeight();
            var dh = docHeight();
            var maxScroll = Math.max(0, dh - vh);
            var ratio = maxScroll <= 0 ? 1 : clamp(y / maxScroll, 0, 1);
            var remaining = Math.max(0, dh - (y + vh));
            var completed = maxScroll <= 0 || remaining <= Math.max(64, vh * 0.03);
            return {
              scrollY: Math.round(y),
              ratio: Number(ratio.toFixed(4)),
              completed: completed
            };
          }

          function saveProgress() {
            var m = metrics();
            var entry = {
              url: path,
              order: chapterOrder,
              title: chapterTitle || '',
              scrollY: m.scrollY,
              ratio: m.ratio,
              completed: m.completed,
              updatedAt: new Date().toISOString()
            };

            localStorage.setItem(lastUrlKey, path);
            localStorage.setItem(stateKey, JSON.stringify({
              lastUrl: entry.url,
              lastOrder: entry.order,
              lastTitle: entry.title,
              scrollY: entry.scrollY,
              ratio: entry.ratio,
              completed: entry.completed,
              updatedAt: entry.updatedAt
            }));

            var chapters = safeParse(localStorage.getItem(chaptersKey), {});
            if (!chapters || typeof chapters !== 'object' || Array.isArray(chapters)) chapters = {};
            chapters[path] = entry;
            localStorage.setItem(chaptersKey, JSON.stringify(chapters));
          }

          function scheduleSave() {
            if (saveTimer) return;
            saveTimer = setTimeout(function() {
              saveTimer = null;
              saveProgress();
            }, 250);
          }

          function restoreProgress() {
            if (restored) return;
            if (location.hash) return;

            var chapters = safeParse(localStorage.getItem(chaptersKey), {});
            if (!chapters || typeof chapters !== 'object') return;

            var entry = chapters[path];
            if (!entry || entry.completed) return;

            var target = null;
            if (typeof entry.scrollY === 'number' && isFinite(entry.scrollY)) {
              target = entry.scrollY;
            }
            if ((target == null || target <= 0) && typeof entry.ratio === 'number' && isFinite(entry.ratio)) {
              var maxScroll = Math.max(0, docHeight() - viewportHeight());
              target = clamp(entry.ratio, 0, 1) * maxScroll;
            }
            if (target == null || target < 48) return;

            restored = true;
            var apply = function() {
              var maxScroll = Math.max(0, docHeight() - viewportHeight());
              window.scrollTo(0, clamp(Math.round(target), 0, maxScroll));
            };

            requestAnimationFrame(function() {
              requestAnimationFrame(apply);
            });
            window.addEventListener('load', apply, { once: true });
            setTimeout(apply, 250);
            setTimeout(apply, 800);
          }

          restoreProgress();
          saveProgress();

          window.addEventListener('scroll', scheduleSave, { passive: true });
          window.addEventListener('resize', scheduleSave);
          window.addEventListener('pagehide', saveProgress);
          window.addEventListener('beforeunload', saveProgress);
          document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') saveProgress();
          });
        } catch(e) {}
      })();

      // Reading UI chrome: top progress bar + end-of-chapter completion panel
      (function() {
        var progressBar = document.getElementById('readProgressBar');
        var completionPanel = document.getElementById('chapterCompletionPanel');
        var completionText = document.getElementById('chapterCompletionText');
        var nextLink = document.querySelector('.pager a[rel="next"]');
        var rafPending = false;

        function clamp(n, min, max) {
          return Math.min(max, Math.max(min, n));
        }

        function docHeight() {
          var d = document.documentElement;
          var b = document.body;
          return Math.max(
            d ? d.scrollHeight : 0,
            d ? d.offsetHeight : 0,
            b ? b.scrollHeight : 0,
            b ? b.offsetHeight : 0
          );
        }

        function viewportHeight() {
          return window.innerHeight || (document.documentElement && document.documentElement.clientHeight) || 0;
        }

        function metrics() {
          var y = window.scrollY || window.pageYOffset || (document.documentElement && document.documentElement.scrollTop) || 0;
          var vh = viewportHeight();
          var dh = docHeight();
          var maxScroll = Math.max(0, dh - vh);
          var ratio = maxScroll <= 0 ? 1 : clamp(y / maxScroll, 0, 1);
          var remaining = Math.max(0, dh - (y + vh));
          var completed = maxScroll <= 0 || remaining <= Math.max(64, vh * 0.03);
          return { ratio: ratio, completed: completed };
        }

        function renderProgress(ratio) {
          if (!progressBar) return;
          progressBar.style.transform = 'scaleX(' + clamp(ratio, 0, 1) + ')';
        }

        function setCompletionVisible(visible) {
          if (!completionPanel) return;
          completionPanel.hidden = !visible;
        }

        function render() {
          rafPending = false;
          var m = metrics();
          renderProgress(m.ratio);
          setCompletionVisible(m.completed);
        }

        function scheduleRender() {
          if (rafPending) return;
          rafPending = true;
          requestAnimationFrame(render);
        }

        if (completionText) {
          completionText.textContent = nextLink ? 'Nice. Ready for the next chapter?' : 'You reached the end of this novel.';
        }

        window.addEventListener('scroll', scheduleRender, { passive: true });
        window.addEventListener('resize', scheduleRender);

        scheduleRender();
        window.addEventListener('load', scheduleRender, { once: true });
        setTimeout(scheduleRender, 250);
        setTimeout(scheduleRender, 800);
      })();

      // Prefetch next chapter for faster transitions (best effort)
      (function() {
        try {
          var nextLink = document.querySelector('.pager a[rel="next"]');
          if (!nextLink || !nextLink.href) return;

          var prefetch = document.createElement('link');
          prefetch.rel = 'prefetch';
          prefetch.as = 'document';
          prefetch.href = nextLink.href;
          document.head.appendChild(prefetch);
        } catch (e) {}
      })();

      // Ink That Reached Me: render journal box entries in monospace/preformatted text
      // and normalize closing border alignment after markdown/inline formatting renders.
      (function() {
        try {
          var bodyData = (document.body && document.body.dataset) || {};
          if (bodyData.novel !== 'ink-that-reached-me') return;

          var article = document.querySelector('main.reader article');
          if (!article) return;

          var boxChars = /[╔╗╚╝║╠╣═┏┓┗┛┃┣┫━│|]/;
          var verticalEdgeChars = /[║┃│|]/;

          function splitJournalHtmlLines(html) {
            var parts = String(html || '').split(/<br\s*\/?>/i);
            return parts.map(function(part, index) {
              if (index === 0) return part;
              return part.replace(/^\r?\n/, '');
            });
          }

          function makeMeasurer(source) {
            var cs = window.getComputedStyle(source);
            var m = document.createElement('span');
            m.setAttribute('aria-hidden', 'true');
            m.style.position = 'absolute';
            m.style.left = '-99999px';
            m.style.top = '0';
            m.style.visibility = 'hidden';
            m.style.display = 'inline-block';
            m.style.whiteSpace = 'pre';
            m.style.margin = '0';
            m.style.padding = '0';
            m.style.border = '0';
            m.style.font = cs.font;
            m.style.fontKerning = cs.fontKerning;
            m.style.fontFeatureSettings = cs.fontFeatureSettings;
            m.style.fontVariantLigatures = cs.fontVariantLigatures;
            m.style.letterSpacing = cs.letterSpacing;
            m.style.wordSpacing = cs.wordSpacing;
            m.style.lineHeight = cs.lineHeight;
            m.style.tabSize = cs.tabSize;
            document.body.appendChild(m);
            return m;
          }

          function measureHtmlWidth(measurer, html) {
            measurer.innerHTML = html;
            return measurer.getBoundingClientRect().width || 0;
          }

          function findLastTextNode(node) {
            if (!node) return null;
            for (var i = node.childNodes.length - 1; i >= 0; i--) {
              var child = node.childNodes[i];
              if (child.nodeType === 3) return child;
              if (child.nodeType === 1) {
                var nested = findLastTextNode(child);
                if (nested) return nested;
              }
            }
            return null;
          }

          function addPadBeforeTrailingBorder(lineHtml, deltaPx) {
            if (!(deltaPx > 0.25)) return lineHtml;

            var wrap = document.createElement('span');
            wrap.innerHTML = lineHtml;

            var lastText = findLastTextNode(wrap);
            if (!lastText || !lastText.nodeValue) return lineHtml;

            var value = lastText.nodeValue;
            var m = value.match(/([║┃│|])(\s*)$/);
            if (!m) return lineHtml;

            var edgeChar = m[1];
            var trailing = m[2] || '';
            var edgeIndex = value.length - trailing.length - 1;
            var before = value.slice(0, edgeIndex);
            var after = value.slice(edgeIndex + 1);

            lastText.nodeValue = before;

            var spacer = document.createElement('span');
            spacer.className = 'journal-pad';
            spacer.setAttribute('aria-hidden', 'true');
            spacer.style.width = deltaPx.toFixed(3) + 'px';

            var parent = lastText.parentNode;
            var next = lastText.nextSibling;
            parent.insertBefore(spacer, next);
            parent.insertBefore(document.createTextNode(edgeChar + after), spacer.nextSibling);

            return wrap.innerHTML;
          }

          article.querySelectorAll('p').forEach(function(p) {
            var text = p.textContent || '';
            if (!boxChars.test(text)) return;
            // Require multiple lines to avoid styling normal prose that contains a symbol.
            if ((text.match(/\n/g) || []).length < 2) return;
            if (!/JOURNAL ENTRY/.test(text) && !/^[\s]*[╔┏|]/m.test(text)) return;
            p.classList.add('journal-box');

            var htmlLines = splitJournalHtmlLines(p.innerHTML);
            if (htmlLines.length < 2) return;

            var measurer = makeMeasurer(p);
            try {
              var rows = htmlLines.map(function(lineHtml) {
                var probe = document.createElement('span');
                probe.innerHTML = lineHtml;
                var lineText = (probe.textContent || '').replace(/\r?\n/g, '');
                return {
                  html: lineHtml,
                  text: lineText,
                  width: measureHtmlWidth(measurer, lineHtml)
                };
              });

              var targetWidth = 0;
              rows.forEach(function(row) {
                if (row.width > targetWidth) targetWidth = row.width;
              });
              if (!(targetWidth > 0)) return;

              var changed = false;
              var normalized = rows.map(function(row) {
                var lineText = row.text || '';
                if (!lineText) return row.html;

                var first = lineText.charAt(0);
                var last = lineText.charAt(lineText.length - 1);
                if (!verticalEdgeChars.test(first) || !verticalEdgeChars.test(last)) return row.html;

                var delta = targetWidth - row.width;
                if (!(delta > 0.25)) return row.html;

                var nextHtml = addPadBeforeTrailingBorder(row.html, delta);
                if (nextHtml !== row.html) changed = true;
                return nextHtml;
              });

              if (changed) {
                p.innerHTML = normalized.join('<br>\n');
              }
            } finally {
              if (measurer && measurer.parentNode) measurer.parentNode.removeChild(measurer);
            }
          });
        } catch (e) {}
      })();
    </script>
  </body>
</html>
