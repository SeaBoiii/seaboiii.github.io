<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page.Title | default: page.title }} · {{ site.title }}</title>
    <meta name="theme-color" content="#ffffff" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --card: #ffffff;
        --border: #e6e6e6;
        --link: #111111;
        --btn-bg: #111111;
        --btn-text: #ffffff;
        --btn-brd: #111111;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        --quote-bar: #b9c0cb;
        --quote-bg: #f4f6f8;
        --quote-text: #111111;
        --quote-strong: #0b0d10;
        --reader-font-scale: 1;
        --reader-line-height: 1.75;
        --reader-max-width: 800px;
        --reader-font-family: "Georgia", "Times New Roman", serif;
        color-scheme: light dark;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0e13;
          --text: #e7eaf0;
          --muted: #a8b2c1;
          --card: #11151d;
          --border: #253043;
          --link: #e7eaf0;
          --btn-bg: #e7eaf0;
          --btn-text: #0b0e13;
          --btn-brd: #e7eaf0;
          --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
          --quote-bar: #5a6474;
          --quote-bg: #0f141c;
          --quote-text: #eef2f8;
          --quote-strong: #ffffff;
        }
      }

      :root[data-theme="light"] {
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --card: #ffffff;
        --border: #e6e6e6;
        --link: #111111;
        --btn-bg: #111111;
        --btn-text: #ffffff;
        --btn-brd: #111111;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        --quote-bar: #b9c0cb;
        --quote-bg: #f4f6f8;
        --quote-text: #111111;
        --quote-strong: #0b0d10;
      }

      :root[data-theme="dark"] {
        --bg: #0b0e13;
        --text: #e7eaf0;
        --muted: #a8b2c1;
        --card: #11151d;
        --border: #253043;
        --link: #e7eaf0;
        --btn-bg: #e7eaf0;
        --btn-text: #0b0e13;
        --btn-brd: #e7eaf0;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        --quote-bar: #5a6474;
        --quote-bg: #0f141c;
        --quote-text: #eef2f8;
        --quote-strong: #ffffff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        background: var(--bg);
        color: var(--text);
        transition: background 0.2s ease, color 0.2s ease;
      }

      a {
        color: var(--link);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .site-header {
        position: sticky;
        top: 0;
        z-index: 30;
        background: color-mix(in oklab, var(--bg), var(--card) 40%);
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(8px);
        padding: 0.85rem 1.25rem;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      }

      .read-progress {
        position: absolute;
        left: 0;
        right: 0;
        bottom: -1px;
        height: 3px;
        background: color-mix(in oklab, var(--border), transparent 45%);
        overflow: hidden;
      }

      .read-progress-fill {
        height: 100%;
        width: 100%;
        transform-origin: left center;
        transform: scaleX(0);
        background: var(--btn-bg);
        transition: transform 0.08s linear;
      }

      .header-content {
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .brand {
        font-weight: 600;
        font-size: 1.05rem;
        font-family: "Merriweather", serif;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .reader-controls {
        display: flex;
        align-items: center;
        gap: 0.45rem;
      }

      .crumbs {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .crumbs a {
        color: var(--muted);
      }

      .crumbs a:hover {
        color: var(--text);
      }

      .theme-toggle {
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 8px;
        padding: 0.4rem 0.5rem;
        cursor: pointer;
        font-size: 0.9rem;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      }

      .theme-toggle:hover {
        filter: brightness(1.05);
      }

      .reader-settings-toggle {
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .reader-settings {
        position: fixed;
        top: 4.3rem;
        right: 1rem;
        z-index: 40;
        width: min(320px, calc(100vw - 1rem));
        padding: 0.8rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--card);
        box-shadow: 0 18px 46px rgba(0, 0, 0, 0.24);
      }

      .reader-settings[hidden] {
        display: none;
      }

      .reader-settings-title {
        margin: 0 0 0.5rem;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 0.92rem;
        font-weight: 700;
      }

      .reader-settings-grid {
        display: grid;
        gap: 0.55rem;
      }

      .reader-setting {
        display: grid;
        gap: 0.32rem;
      }

      .reader-setting label {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 0.8rem;
      }

      .reader-setting label strong {
        font-weight: 600;
      }

      .reader-setting-value {
        color: var(--muted);
      }

      .reader-setting input[type="range"] {
        width: 100%;
      }

      .reader-setting select {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--card);
        color: var(--text);
        padding: 0.5rem 0.55rem;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 0.85rem;
      }

      .reader-settings-actions {
        margin-top: 0.2rem;
        display: flex;
        justify-content: flex-end;
      }

      .reader-settings-reset {
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 8px;
        padding: 0.42rem 0.6rem;
        cursor: pointer;
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 0.8rem;
      }

      .reader-settings-reset:hover {
        background: color-mix(in oklab, var(--card), var(--text) 6%);
      }

      .reader {
        max-width: var(--reader-max-width);
        margin: 0 auto;
        padding: 2rem 1.25rem 4rem;
      }

      article {
        font-family: var(--reader-font-family);
        font-size: clamp(
          calc(1.05rem * var(--reader-font-scale)),
          calc(2.2vw * var(--reader-font-scale)),
          calc(1.15rem * var(--reader-font-scale))
        );
        line-height: var(--reader-line-height);
      }

      article h1 {
        font-family: var(--reader-font-family);
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        line-height: 1.2;
        margin: 0 0 0.5rem;
        font-weight: 600;
      }

      .chapter-meta {
        color: var(--muted);
        font-size: 0.95rem;
        margin-bottom: 2rem;
        font-family: system-ui, -apple-system, sans-serif;
      }

      article p {
        margin: 0 0 1.25rem;
      }

      article p.journal-box {
        margin: 1.3rem 0 1.45rem;
        padding: 0.7rem 0.85rem;
        white-space: pre;
        overflow-x: auto;
        line-height: 1.22;
        font-size: 0.95rem;
        letter-spacing: 0;
        word-spacing: 0;
        tab-size: 2;
        font-kerning: none;
        font-variant-ligatures: none;
        font-feature-settings: "liga" 0, "calt" 0;
        font-family: "Cascadia Mono", "Consolas", "Courier New", "MS Gothic", monospace;
        color: var(--text);
        background: color-mix(in oklab, var(--card), var(--bg) 25%);
        border: 1px solid color-mix(in oklab, var(--border), transparent 15%);
        border-radius: 10px;
      }

      article p.journal-box em,
      article p.journal-box strong,
      article p.journal-box code {
        font-family: inherit;
      }

      article hr {
        border: 0;
        border-top: 1px solid color-mix(in oklab, var(--border), transparent 35%);
        width: min(34ch, 58%);
        margin: 2rem auto;
        opacity: 0.75;
      }

      article blockquote {
        margin: 1.1rem 0 1.35rem;
        padding: 0.35rem 0 0.35rem 0.95rem;
        border-left: 4px solid var(--quote-bar);
        color: var(--quote-text);
        background: var(--quote-bg);
        border-radius: 0 8px 8px 0;
      }

      article blockquote p {
        margin: 0 0 0.7rem;
      }

      article blockquote strong {
        color: var(--quote-strong);
      }

      article blockquote p:last-child {
        margin-bottom: 0;
      }

      article h2,
      article h3 {
        line-height: 1.3;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
      }

      .pager {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 0.75rem;
        margin-top: 2.25rem;
        padding: 0.85rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--card);
        box-shadow: var(--shadow);
        align-items: center;
      }

      .pager .btn {
        display: inline-block;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--card);
        color: var(--text);
        text-decoration: none;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .pager .btn:hover {
        background: var(--btn-bg);
        color: var(--btn-text);
        border-color: var(--btn-brd);
        text-decoration: none;
      }

      .pager .prev {
        justify-self: start;
      }

      .pager .next {
        justify-self: end;
      }

      .pager .toc {
        justify-self: center;
        font-weight: 600;
      }

      .pager .next {
        font-weight: 700;
        background: var(--btn-bg);
        color: var(--btn-text);
        border-color: var(--btn-brd);
      }

      .pager .next:hover {
        filter: brightness(1.06);
        text-decoration: none;
      }

      .pager .btn.disabled {
        opacity: 0.6;
        pointer-events: none;
      }

      .pager span:empty {
        visibility: hidden;
      }

      .chapter-complete {
        margin-top: 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.8rem;
        padding: 0.8rem 0.9rem;
        border: 1px solid color-mix(in oklab, var(--btn-brd), var(--border) 50%);
        border-radius: 12px;
        background: color-mix(in oklab, var(--card), var(--btn-bg) 4%);
        box-shadow: var(--shadow);
      }

      .chapter-complete-copy {
        display: grid;
        gap: 0.12rem;
        min-width: 0;
      }

      .chapter-complete-copy strong {
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 0.95rem;
      }

      .chapter-complete-copy span {
        color: var(--muted);
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.87rem;
      }

      .mobile-chapter-nav {
        display: none;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 25;
        border-top: 1px solid var(--border);
        background: color-mix(in oklab, var(--bg), var(--card) 35%);
        backdrop-filter: blur(8px);
      }

      .mobile-chapter-nav .inner {
        max-width: 800px;
        margin: 0 auto;
        padding: 0.5rem 0.9rem calc(0.5rem + env(safe-area-inset-bottom));
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 0.5rem;
        align-items: center;
      }

      .mobile-chapter-nav .m-btn {
        display: inline-block;
        text-align: center;
        text-decoration: none;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--card);
        color: var(--text);
        padding: 0.65rem 0.7rem;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.9rem;
        line-height: 1.15;
      }

      .mobile-chapter-nav .m-btn.prev {
        justify-self: start;
      }

      .mobile-chapter-nav .m-btn.toc {
        justify-self: center;
        font-weight: 600;
      }

      .mobile-chapter-nav .m-btn.next {
        justify-self: end;
        border-color: var(--btn-brd);
        background: var(--btn-bg);
        color: var(--btn-text);
        font-weight: 700;
      }

      .mobile-chapter-nav .m-btn.disabled {
        opacity: 0.55;
        pointer-events: none;
      }

      @media (max-width: 640px) {
        .reader {
          padding-bottom: 6.75rem;
        }

        .reader-settings {
          top: 4.9rem;
          right: 0.5rem;
          width: min(330px, calc(100vw - 1rem));
        }

        .chapter-complete {
          flex-direction: column;
          align-items: stretch;
        }

        .pager {
          grid-template-columns: 1fr;
        }

        .pager .prev,
        .pager .next,
        .pager .toc {
          justify-self: stretch;
          text-align: center;
        }

        .mobile-chapter-nav {
          display: block;
        }
      }
    </style>
  </head>
  <body
    data-novel="{{ page.novel | escape }}"
    data-chapter-order="{{ page.order | default: '' }}"
    data-chapter-title="{{ page.Title | default: page.title | escape }}"
  >
    <header class="site-header">
      <div class="header-content">
        <a class="brand" href="{{ "/novel/" | relative_url }}">{{ site.title }}</a>
        <div class="header-right">
          <nav class="crumbs">
            <a href="{{ "/novel/" | relative_url }}">All Novels</a>
            <span>/</span>
            <a href="{{ "/novel/" | append: page.novel | append: "/" | relative_url }}">
              {{ page.novel | replace: '-', ' ' | capitalize }}
            </a>
          </nav>
          <div class="reader-controls">
            <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle theme">🌙</button>
            <button
              id="readerSettingsToggle"
              class="theme-toggle reader-settings-toggle"
              type="button"
              aria-label="Reader settings"
              aria-haspopup="dialog"
              aria-expanded="false"
              aria-controls="readerSettingsPanel"
            >
              Aa
            </button>
          </div>
        </div>
      </div>
      <section id="readerSettingsPanel" class="reader-settings" role="dialog" aria-label="Reader settings" hidden>
        <p class="reader-settings-title">Reader settings</p>
        <div class="reader-settings-grid">
          <div class="reader-setting">
            <label for="readerFontSize">
              <strong>Font size</strong>
              <span id="readerFontSizeValue" class="reader-setting-value"></span>
            </label>
            <input id="readerFontSize" type="range" min="0.85" max="1.35" step="0.05" value="1" />
          </div>
          <div class="reader-setting">
            <label for="readerLineHeight">
              <strong>Line height</strong>
              <span id="readerLineHeightValue" class="reader-setting-value"></span>
            </label>
            <input id="readerLineHeight" type="range" min="1.45" max="2.1" step="0.05" value="1.75" />
          </div>
          <div class="reader-setting">
            <label for="readerContentWidth">
              <strong>Content width</strong>
              <span id="readerContentWidthValue" class="reader-setting-value"></span>
            </label>
            <input id="readerContentWidth" type="range" min="620" max="980" step="20" value="800" />
          </div>
          <div class="reader-setting">
            <label for="readerFontFamily">
              <strong>Font family</strong>
            </label>
            <select id="readerFontFamily">
              <option value="serif">Classic Serif</option>
              <option value="book">Book Serif</option>
              <option value="sans">Clean Sans</option>
              <option value="mono">Monospace</option>
            </select>
          </div>
        </div>
        <div class="reader-settings-actions">
          <button id="readerSettingsReset" class="reader-settings-reset" type="button">Reset</button>
        </div>
      </section>
      <div class="read-progress" aria-hidden="true">
        <div id="readProgressBar" class="read-progress-fill"></div>
      </div>
    </header>

    <main class="reader">
      <article>
        <h1>{{ page.Title | default: page.title }}</h1>
        {% if page.order %}<div class="chapter-meta">Chapter {{ page.order }}</div>{% endif %}
        {{ content }}
      </article>

{% comment %}Build ordered list of chapter pages in this novel{% endcomment %}
{% assign pathprefix = '/novel/' | append: page.novel | append: '/' %}
{% assign siblings = site.pages
  | where_exp: 'p', 'p.url contains pathprefix'
  | where_exp: 'p', 'p.name != "index.md"'
  | sort: 'order' %}

{% comment %}Find current page index{% endcomment %}
{% assign idx = -1 %}
{% for c in siblings %}
  {% if c.url == page.url %}
    {% assign idx = forloop.index0 %}
  {% endif %}
{% endfor %}
{% assign count = siblings | size %}

{% comment %}Compute prev/next indices BEFORE indexing the array{% endcomment %}
{% assign prev_index = idx | minus: 1 %}
{% assign next_index = idx | plus: 1 %}
{% assign toc = site.pages | where_exp: 'p', 'p.url == pathprefix' | first %}
{% assign toc_url = toc.url | default: pathprefix | append: 'index.html' %}


<!--
<section id="chapterCompletionPanel" class="chapter-complete" hidden aria-live="polite">
  <div class="chapter-complete-copy">
    <strong id="chapterCompletionTitle">Chapter completed</strong>
    <span id="chapterCompletionText">Nice. Ready for the next chapter?</span>
  </div>
</section>
-->

<nav class="pager">
  {% if prev_index >= 0 %}
    {% assign prev = siblings[prev_index] %}
    <a class="btn prev" rel="prev" href="{{ prev.url | relative_url }}">Previous chapter</a>
  {% else %}
    <span></span>
  {% endif %}

  {% if page.url == toc_url %}
    <span class="btn toc" aria-current="page">Back to chapters</span>
  {% else %}
    <a class="btn toc" href="{{ toc_url | relative_url }}">Back to chapters</a>
  {% endif %}

  {% if next_index < count and next_index >= 0 %}
    {% assign next = siblings[next_index] %}
    <a class="btn next" rel="next" href="{{ next.url | relative_url }}">Next chapter</a>
  {% else %}
    <span class="btn next disabled" aria-disabled="true">End of novel</span>
  {% endif %}
</nav>
    </main>

    <nav class="mobile-chapter-nav" aria-label="Chapter navigation">
      <div class="inner">
        {% if prev_index >= 0 %}
          {% assign prev = siblings[prev_index] %}
          <a class="m-btn prev" href="{{ prev.url | relative_url }}">Prev</a>
        {% else %}
          <span class="m-btn prev disabled" aria-disabled="true">Prev</span>
        {% endif %}

        <a class="m-btn toc" href="{{ toc_url | relative_url }}">Chapters</a>

        {% if next_index < count and next_index >= 0 %}
          {% assign next = siblings[next_index] %}
          <a class="m-btn next" href="{{ next.url | relative_url }}">Next</a>
        {% else %}
          <span class="m-btn next disabled" aria-disabled="true">End</span>
        {% endif %}
      </div>
    </nav>

    <script>
      // Theme toggle (synced with rest of site)
      (function () {
        var root = document.documentElement;
        var btn = document.getElementById("themeToggle");
        var storageKey = "site:theme";

        function isDarkNow() {
          var forced = root.getAttribute("data-theme");
          if (forced) return forced === "dark";
          return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        }

        function icon() {
          btn.textContent = isDarkNow() ? "☀️" : "🌙";
          btn.setAttribute(
            "aria-label",
            isDarkNow() ? "Switch to light theme" : "Switch to dark theme"
          );
        }

        function updateThemeColor() {
          var m = document.querySelector('meta[name="theme-color"]');
          if (!m) {
            m = document.createElement("meta");
            m.name = "theme-color";
            document.head.appendChild(m);
          }
          var bg = getComputedStyle(root).getPropertyValue("--bg").trim() || "#ffffff";
          m.setAttribute("content", bg);
        }

        function apply(saved) {
          if (saved === "light" || saved === "dark") {
            root.setAttribute("data-theme", saved);
          } else {
            root.removeAttribute("data-theme");
          }
          icon();
          updateThemeColor();
        }

        var saved = localStorage.getItem(storageKey);
        apply(saved);

        btn.addEventListener("click", function () {
          var cur = localStorage.getItem(storageKey);
          var next = cur === "dark" ? "light" : "dark";
          localStorage.setItem(storageKey, next);
          apply(next);
        });

        if (!saved && window.matchMedia) {
          var mq = window.matchMedia("(prefers-color-scheme: dark)");
          mq.addEventListener("change", function () {
            apply(null);
          });
        }
      })();

      // Reader settings (saved per user)
      (function () {
        var root = document.documentElement;
        var toggle = document.getElementById("readerSettingsToggle");
        var panel = document.getElementById("readerSettingsPanel");
        var reset = document.getElementById("readerSettingsReset");
        var fontSizeInput = document.getElementById("readerFontSize");
        var lineHeightInput = document.getElementById("readerLineHeight");
        var widthInput = document.getElementById("readerContentWidth");
        var fontFamilyInput = document.getElementById("readerFontFamily");
        var fontSizeValue = document.getElementById("readerFontSizeValue");
        var lineHeightValue = document.getElementById("readerLineHeightValue");
        var widthValue = document.getElementById("readerContentWidthValue");

        if (
          !toggle ||
          !panel ||
          !reset ||
          !fontSizeInput ||
          !lineHeightInput ||
          !widthInput ||
          !fontFamilyInput ||
          !fontSizeValue ||
          !lineHeightValue ||
          !widthValue
        ) {
          return;
        }

        var storageKey = "reader:settings:v1";
        var fontStacks = {
          serif: '"Georgia", "Times New Roman", serif',
          book: '"Merriweather", "Georgia", "Times New Roman", serif',
          sans: '"Roboto", "Segoe UI", system-ui, sans-serif',
          mono: '"Cascadia Mono", "Consolas", "Courier New", monospace'
        };
        var defaults = {
          fontScale: 1,
          lineHeight: 1.75,
          maxWidth: 800,
          fontFamily: "serif"
        };
        var settings = {
          fontScale: defaults.fontScale,
          lineHeight: defaults.lineHeight,
          maxWidth: defaults.maxWidth,
          fontFamily: defaults.fontFamily
        };

        function clamp(n, min, max) {
          return Math.min(max, Math.max(min, n));
        }

        function parseNumber(value, fallback) {
          var n = parseFloat(value);
          return Number.isFinite(n) ? n : fallback;
        }

        function normalize(raw) {
          var out = {
            fontScale: defaults.fontScale,
            lineHeight: defaults.lineHeight,
            maxWidth: defaults.maxWidth,
            fontFamily: defaults.fontFamily
          };
          if (!raw || typeof raw !== "object") return out;

          out.fontScale = clamp(parseNumber(raw.fontScale, defaults.fontScale), 0.85, 1.35);
          out.lineHeight = clamp(parseNumber(raw.lineHeight, defaults.lineHeight), 1.45, 2.1);
          out.maxWidth = clamp(Math.round(parseNumber(raw.maxWidth, defaults.maxWidth)), 620, 980);

          var family = String(raw.fontFamily || "").trim();
          out.fontFamily = fontStacks[family] ? family : defaults.fontFamily;
          return out;
        }

        function save() {
          try {
            localStorage.setItem(storageKey, JSON.stringify(settings));
          } catch (e) {}
        }

        function updateValueLabels() {
          fontSizeValue.textContent = Math.round(settings.fontScale * 100) + "%";
          lineHeightValue.textContent = settings.lineHeight.toFixed(2);
          widthValue.textContent = settings.maxWidth + "px";
        }

        function syncInputs() {
          fontSizeInput.value = String(settings.fontScale);
          lineHeightInput.value = String(settings.lineHeight);
          widthInput.value = String(settings.maxWidth);
          fontFamilyInput.value = settings.fontFamily;
        }

        function apply() {
          root.style.setProperty("--reader-font-scale", settings.fontScale.toFixed(2));
          root.style.setProperty("--reader-line-height", settings.lineHeight.toFixed(2));
          root.style.setProperty("--reader-max-width", Math.round(settings.maxWidth) + "px");
          root.style.setProperty("--reader-font-family", fontStacks[settings.fontFamily]);
          syncInputs();
          updateValueLabels();
        }

        function openPanel() {
          panel.hidden = false;
          toggle.setAttribute("aria-expanded", "true");
        }

        function closePanel() {
          panel.hidden = true;
          toggle.setAttribute("aria-expanded", "false");
        }

        function togglePanel() {
          if (panel.hidden) openPanel();
          else closePanel();
        }

        try {
          settings = normalize(JSON.parse(localStorage.getItem(storageKey)));
        } catch (e) {
          settings = normalize(null);
        }
        apply();

        fontSizeInput.addEventListener("input", function () {
          settings.fontScale = clamp(parseNumber(fontSizeInput.value, defaults.fontScale), 0.85, 1.35);
          apply();
          save();
        });

        lineHeightInput.addEventListener("input", function () {
          settings.lineHeight = clamp(parseNumber(lineHeightInput.value, defaults.lineHeight), 1.45, 2.1);
          apply();
          save();
        });

        widthInput.addEventListener("input", function () {
          settings.maxWidth = clamp(Math.round(parseNumber(widthInput.value, defaults.maxWidth)), 620, 980);
          apply();
          save();
        });

        fontFamilyInput.addEventListener("change", function () {
          var value = String(fontFamilyInput.value || "").trim();
          settings.fontFamily = fontStacks[value] ? value : defaults.fontFamily;
          apply();
          save();
        });

        reset.addEventListener("click", function () {
          settings = normalize(defaults);
          apply();
          save();
        });

        toggle.addEventListener("click", function (event) {
          event.stopPropagation();
          togglePanel();
        });

        panel.addEventListener("click", function (event) {
          event.stopPropagation();
        });

        document.addEventListener("click", function (event) {
          if (panel.hidden) return;
          if (panel.contains(event.target) || toggle.contains(event.target)) return;
          closePanel();
        });

        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape" && !panel.hidden) {
            closePanel();
          }
        });
      })();

      // Swipe left/right on mobile for chapter navigation
      (function () {
        var prevLink = document.querySelector('.pager a[rel="prev"]');
        var nextLink = document.querySelector('.pager a[rel="next"]');
        if (!prevLink && !nextLink) return;

        var touchSupported = "ontouchstart" in window || navigator.maxTouchPoints > 0;
        if (!touchSupported) return;

        var startX = 0;
        var startY = 0;
        var startedAt = 0;
        var tracking = false;
        var blocked = false;
        var MIN_DISTANCE = 78;
        var MAX_VERTICAL = 84;
        var MAX_DURATION = 720;
        var EDGE_GUARD = 24;

        function hasHorizontalScrollParent(target) {
          var node = target;
          while (node && node !== document.body) {
            var style = window.getComputedStyle(node);
            var overflowX = style ? style.overflowX : "";
            if ((overflowX === "auto" || overflowX === "scroll") && node.scrollWidth > node.clientWidth + 6) {
              return true;
            }
            node = node.parentElement;
          }
          return false;
        }

        function isInteractiveTarget(target) {
          if (!target || !target.closest) return false;
          return !!target.closest(
            'input, select, textarea, button, [role="button"], a[href], .reader-settings'
          );
        }

        document.addEventListener(
          "touchstart",
          function (event) {
            if (!event.touches || event.touches.length !== 1) {
              tracking = false;
              blocked = true;
              return;
            }

            var touch = event.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            startedAt = Date.now();
            blocked =
              startX <= EDGE_GUARD ||
              startX >= window.innerWidth - EDGE_GUARD ||
              hasHorizontalScrollParent(event.target) ||
              isInteractiveTarget(event.target);
            tracking = !blocked;
          },
          { passive: true }
        );

        document.addEventListener(
          "touchcancel",
          function () {
            tracking = false;
            blocked = false;
          },
          { passive: true }
        );

        document.addEventListener(
          "touchend",
          function (event) {
            if (!tracking || blocked || !event.changedTouches || !event.changedTouches.length) {
              tracking = false;
              blocked = false;
              return;
            }

            var touch = event.changedTouches[0];
            var dx = touch.clientX - startX;
            var dy = touch.clientY - startY;
            var elapsed = Date.now() - startedAt;
            tracking = false;
            blocked = false;

            if (elapsed > MAX_DURATION) return;
            if (Math.abs(dx) < MIN_DISTANCE) return;
            if (Math.abs(dy) > MAX_VERTICAL) return;
            if (Math.abs(dx) <= Math.abs(dy) * 1.3) return;

            if (dx < 0 && nextLink && nextLink.href) {
              window.location.href = nextLink.href;
            } else if (dx > 0 && prevLink && prevLink.href) {
              window.location.href = prevLink.href;
            }
          },
          { passive: true }
        );
      })();

      // Save + restore reading progress
      (function() {
        try {
          var bodyData = (document.body && document.body.dataset) || {};
          var novel = bodyData.novel || '';
          if (!novel) return;

          var chapterOrderRaw = bodyData.chapterOrder || '';
          var chapterOrder = (typeof chapterOrderRaw === 'number')
            ? chapterOrderRaw
            : parseInt(chapterOrderRaw, 10);
          if (!isFinite(chapterOrder)) chapterOrder = null;

          var chapterTitle = bodyData.chapterTitle || '';
          var path = location.pathname;
          var lastUrlKey = 'novel:'+novel+':lastUrl';
          var stateKey = 'novel:'+novel+':state';
          var chaptersKey = 'novel:'+novel+':chapters';
          var saveTimer = null;
          var restored = false;

          function clamp(n, min, max) {
            return Math.min(max, Math.max(min, n));
          }

          function safeParse(raw, fallback) {
            if (!raw) return fallback;
            try { return JSON.parse(raw); } catch (e) { return fallback; }
          }

          function docHeight() {
            var d = document.documentElement;
            var b = document.body;
            return Math.max(
              d ? d.scrollHeight : 0,
              d ? d.offsetHeight : 0,
              b ? b.scrollHeight : 0,
              b ? b.offsetHeight : 0
            );
          }

          function viewportHeight() {
            return window.innerHeight || (document.documentElement && document.documentElement.clientHeight) || 0;
          }

          function metrics() {
            var y = window.scrollY || window.pageYOffset || (document.documentElement && document.documentElement.scrollTop) || 0;
            var vh = viewportHeight();
            var dh = docHeight();
            var maxScroll = Math.max(0, dh - vh);
            var ratio = maxScroll <= 0 ? 1 : clamp(y / maxScroll, 0, 1);
            var remaining = Math.max(0, dh - (y + vh));
            var completed = maxScroll <= 0 || remaining <= Math.max(64, vh * 0.03);
            return {
              scrollY: Math.round(y),
              ratio: Number(ratio.toFixed(4)),
              completed: completed
            };
          }

          function saveProgress() {
            var m = metrics();
            var entry = {
              url: path,
              order: chapterOrder,
              title: chapterTitle || '',
              scrollY: m.scrollY,
              ratio: m.ratio,
              completed: m.completed,
              updatedAt: new Date().toISOString()
            };

            localStorage.setItem(lastUrlKey, path);
            localStorage.setItem(stateKey, JSON.stringify({
              lastUrl: entry.url,
              lastOrder: entry.order,
              lastTitle: entry.title,
              scrollY: entry.scrollY,
              ratio: entry.ratio,
              completed: entry.completed,
              updatedAt: entry.updatedAt
            }));

            var chapters = safeParse(localStorage.getItem(chaptersKey), {});
            if (!chapters || typeof chapters !== 'object' || Array.isArray(chapters)) chapters = {};
            chapters[path] = entry;
            localStorage.setItem(chaptersKey, JSON.stringify(chapters));
          }

          function scheduleSave() {
            if (saveTimer) return;
            saveTimer = setTimeout(function() {
              saveTimer = null;
              saveProgress();
            }, 250);
          }

          function restoreProgress() {
            if (restored) return;
            if (location.hash) return;

            var chapters = safeParse(localStorage.getItem(chaptersKey), {});
            if (!chapters || typeof chapters !== 'object') return;

            var entry = chapters[path];
            if (!entry || entry.completed) return;

            var target = null;
            if (typeof entry.scrollY === 'number' && isFinite(entry.scrollY)) {
              target = entry.scrollY;
            }
            if ((target == null || target <= 0) && typeof entry.ratio === 'number' && isFinite(entry.ratio)) {
              var maxScroll = Math.max(0, docHeight() - viewportHeight());
              target = clamp(entry.ratio, 0, 1) * maxScroll;
            }
            if (target == null || target < 48) return;

            restored = true;
            var apply = function() {
              var maxScroll = Math.max(0, docHeight() - viewportHeight());
              window.scrollTo(0, clamp(Math.round(target), 0, maxScroll));
            };

            requestAnimationFrame(function() {
              requestAnimationFrame(apply);
            });
            window.addEventListener('load', apply, { once: true });
            setTimeout(apply, 250);
            setTimeout(apply, 800);
          }

          restoreProgress();
          saveProgress();

          window.addEventListener('scroll', scheduleSave, { passive: true });
          window.addEventListener('resize', scheduleSave);
          window.addEventListener('pagehide', saveProgress);
          window.addEventListener('beforeunload', saveProgress);
          document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') saveProgress();
          });
        } catch(e) {}
      })();

      // Reading UI chrome: top progress bar + end-of-chapter completion panel
      (function() {
        var progressBar = document.getElementById('readProgressBar');
        var completionPanel = document.getElementById('chapterCompletionPanel');
        var completionText = document.getElementById('chapterCompletionText');
        var nextLink = document.querySelector('.pager a[rel="next"]');
        var rafPending = false;

        function clamp(n, min, max) {
          return Math.min(max, Math.max(min, n));
        }

        function docHeight() {
          var d = document.documentElement;
          var b = document.body;
          return Math.max(
            d ? d.scrollHeight : 0,
            d ? d.offsetHeight : 0,
            b ? b.scrollHeight : 0,
            b ? b.offsetHeight : 0
          );
        }

        function viewportHeight() {
          return window.innerHeight || (document.documentElement && document.documentElement.clientHeight) || 0;
        }

        function metrics() {
          var y = window.scrollY || window.pageYOffset || (document.documentElement && document.documentElement.scrollTop) || 0;
          var vh = viewportHeight();
          var dh = docHeight();
          var maxScroll = Math.max(0, dh - vh);
          var ratio = maxScroll <= 0 ? 1 : clamp(y / maxScroll, 0, 1);
          var remaining = Math.max(0, dh - (y + vh));
          var completed = maxScroll <= 0 || remaining <= Math.max(64, vh * 0.03);
          return { ratio: ratio, completed: completed };
        }

        function renderProgress(ratio) {
          if (!progressBar) return;
          progressBar.style.transform = 'scaleX(' + clamp(ratio, 0, 1) + ')';
        }

        function setCompletionVisible(visible) {
          if (!completionPanel) return;
          completionPanel.hidden = !visible;
        }

        function render() {
          rafPending = false;
          var m = metrics();
          renderProgress(m.ratio);
          setCompletionVisible(m.completed);
        }

        function scheduleRender() {
          if (rafPending) return;
          rafPending = true;
          requestAnimationFrame(render);
        }

        if (completionText) {
          completionText.textContent = nextLink ? 'Nice. Ready for the next chapter?' : 'You reached the end of this novel.';
        }

        window.addEventListener('scroll', scheduleRender, { passive: true });
        window.addEventListener('resize', scheduleRender);

        scheduleRender();
        window.addEventListener('load', scheduleRender, { once: true });
        setTimeout(scheduleRender, 250);
        setTimeout(scheduleRender, 800);
      })();

      // Prefetch next chapter for faster transitions (best effort)
      (function() {
        try {
          var nextLink = document.querySelector('.pager a[rel="next"]');
          if (!nextLink || !nextLink.href) return;

          var prefetch = document.createElement('link');
          prefetch.rel = 'prefetch';
          prefetch.as = 'document';
          prefetch.href = nextLink.href;
          document.head.appendChild(prefetch);
        } catch (e) {}
      })();

      // Ink That Reached Me: render journal box entries in monospace/preformatted text
      // so the vertical borders line up consistently.
      (function() {
        try {
          var bodyData = (document.body && document.body.dataset) || {};
          if (bodyData.novel !== 'ink-that-reached-me') return;

          var article = document.querySelector('main.reader article');
          if (!article) return;

          var boxChars = /[╔╗╚╝║╠╣═┏┓┗┛┃┣┫━│|]/;
          article.querySelectorAll('p').forEach(function(p) {
            var text = p.textContent || '';
            if (!boxChars.test(text)) return;
            // Require multiple lines to avoid styling normal prose that contains a symbol.
            if ((text.match(/\n/g) || []).length < 2) return;
            if (!/JOURNAL ENTRY/.test(text) && !/^[\s]*[╔┏|]/m.test(text)) return;
            p.classList.add('journal-box');
          });
        } catch (e) {}
      })();
    </script>
  </body>
</html>
