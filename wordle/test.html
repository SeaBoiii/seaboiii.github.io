<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Word Guess â€” Vanilla JS + Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tile { width: 3rem; height: 3rem; }
    .kbd { user-select: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-4 md:p-8">
  <div class="max-w-4xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Daily Word Guess</h1>
      <nav class="bg-white/10 rounded-xl p-1 flex gap-1">
        <button id="tabPlayBtn" class="px-4 py-2 rounded-lg bg-white/20">Play</button>
        <button id="tabAdminBtn" class="px-4 py-2 rounded-lg hover:bg-white/10">Admin</button>
      </nav>
    </header>

    <section id="playTab">
      <div class="text-white/80 mb-2">Date: <span id="todayLabel" class="font-mono"></span></div>
      <div class="text-white/90 mb-4">Word length: <strong id="wordLenLabel">-</strong> â€¢ Attempts: <strong id="attemptsLabel">-</strong></div>
      <div class="mb-4 text-white/80">
        <label for="playerNameInput" class="mr-2">Your Name:</label>
        <input id="playerNameInput" type="text" placeholder="Enter your name" class="px-3 py-2 rounded-lg bg-white/10 text-white border border-white/20" />
      </div>
      <div id="grid" class="grid gap-2 mb-4 justify-center"></div>
      <input id="hiddenInput" class="sr-only" />
      <div class="flex gap-2 mb-4 justify-center">
        <button id="typeBtn" class="px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white hover:bg-white/20">Type on Phone</button>
      </div>
      <div id="keyboard" class="mt-2"></div>
      <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 bg-black/70 text-white rounded-xl shadow-lg"></div>
    </section>

    <section id="adminTab" class="hidden">
      <div id="adminAuth"></div>
      <div id="adminPanel" class="hidden"></div>
    </section>

    <footer class="mt-10 text-center text-white/60 text-sm">
      <p>(c) Brought to you by the ATS Engagement Team</p>
    </footer>
  </div>

  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "https://hmbppbnopvjuqqvrgkwl.supabase.co";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "YOUR_ANON_KEY";

    // Default dictionary URL (large English word list)
    window.DICTIONARY_URL = "https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt";

    const STORAGE_KEYS = { CLIENT_ID: "wordleLike.clientId.v1", PLAYER_NAME: "wordleLike.playerName.v1" };
    const alphaOnly = (s) => s.replace(/[^A-Za-z]/g, "");
    const toUpper = (s) => alphaOnly(s).toUpperCase();
    const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

    function getClientId() { let id = localStorage.getItem(STORAGE_KEYS.CLIENT_ID); if (!id) { id = (crypto.randomUUID && crypto.randomUUID()) || String(Math.random()).slice(2); localStorage.setItem(STORAGE_KEYS.CLIENT_ID, id);} return id; }
    function getPlayerName() { return localStorage.getItem(STORAGE_KEYS.PLAYER_NAME) || ""; }
    function setPlayerName(name) { localStorage.setItem(STORAGE_KEYS.PLAYER_NAME, name); }

    const playerNameInput = document.getElementById('playerNameInput');
    playerNameInput.value = getPlayerName();
    playerNameInput.addEventListener('change', () => { setPlayerName(playerNameInput.value.trim()); });

    // Dictionary loader
    let DICT = null;
    async function loadDictionary() {
      try {
        const resp = await fetch(window.DICTIONARY_URL, { cache: "force-cache" });
        const text = await resp.text();
        DICT = new Set(text.split(/\r?\n/).map((w) => toUpper(w)).filter((w) => w.length >= 2));
        console.log(`Loaded dictionary with ${DICT.size} words.`);
      } catch (e) {
        console.error("Failed to load dictionary", e);
        DICT = new Set();
      }
    }
    function isWordValid(word) { return DICT && DICT.has(toUpper(word)); }

    // Supabase client
    let sp = null;
    function getSupabase() {
      if (sp) return sp;
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return null;
      if (!window.supabase || !window.supabase.createClient) return null;
      sp = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      return sp;
    }

    async function saveProgress(date, clientId, payload) { const c = getSupabase(); if (!c) return { error: "Supabase not ready" }; const row = { client_id: clientId, player_name: getPlayerName(), date, ...payload }; const { error } = await c.from("progress").upsert(row, { onConflict: "client_id,date" }); return { error }; }

    // Game logic helpers
    function getStatusForGuess(guess, answer) { const g=guess.split(""); const a=answer.split(""); const status=Array(g.length).fill("absent"); const counts={}; for(let i=0;i<a.length;i++) counts[a[i]]=(counts[a[i]]||0)+1; for(let i=0;i<g.length;i++){ if(g[i]===a[i]){status[i]="correct";counts[g[i]]-=1;}} for(let i=0;i<g.length;i++){ if(status[i]==="correct") continue; const ch=g[i]; if(counts[ch]>0){status[i]="present";counts[ch]-=1;}} return status; }
    function aggregateKeyboard(guesses, answer){const priority={absent:0,present:1,correct:2};const best={};guesses.forEach((g)=>{const st=getStatusForGuess(g,answer);for(let i=0;i<g.length;i++){const ch=g[i];const s=st[i];if(!best[ch]||priority[s]>priority[best[ch]])best[ch]=s;}});return best;}

    const todayLabel=document.getElementById('todayLabel');
    const wordLenLabel=document.getElementById('wordLenLabel');
    const attemptsLabel=document.getElementById('attemptsLabel');
    const grid=document.getElementById('grid');
    const keyboard=document.getElementById('keyboard');
    const toast=document.getElementById('toast');

    let today=todayISO();
    let answer=null;
    let wordLen=5;
    let attempts=wordLen+1;
    let guesses=[];
    let cur="";
    let status='loading';

    function showToast(msg){toast.textContent=msg;toast.classList.remove('hidden');setTimeout(()=>toast.classList.add('hidden'),1500);}

    function buildGrid(){grid.style.gridTemplateRows=`repeat(${attempts},3rem)`;grid.style.gridTemplateColumns=`repeat(${wordLen},3rem)`;grid.innerHTML='';for(let r=0;r<attempts;r++){const guess=guesses[r]||(r===guesses.length?cur.padEnd(wordLen,''):'').padEnd(wordLen,'');const isSubmitted=r<guesses.length;const tiles=guess.split('');let states=Array(wordLen).fill('empty');if(isSubmitted)states=getStatusForGuess(guess,answer);else if(r===guesses.length)states=tiles.map(ch=>ch?'filled':'empty');for(let c=0;c<wordLen;c++){const div=document.createElement('div');div.className=`tile grid place-items-center rounded-lg border text-xl font-bold uppercase transition ${states[c]==='empty'?'bg-white/10 border-white/20 text-white/80 backdrop-blur-sm':states[c]==='filled'?'bg-white/20 border-white/30 text-white backdrop-blur-sm':states[c]==='absent'?'bg-gray-600 border-gray-500 text-white':states[c]==='present'?'bg-yellow-600 border-yellow-500 text-white':'bg-green-600 border-green-500 text-white'}`;div.textContent=tiles[c]||'';grid.appendChild(div);}}}

    function renderKeyboard(){const rows=['QWERTYUIOP'.split(''),'ASDFGHJKL'.split(''),['ENTER',...'ZXCVBNM'.split(''),'âŒ«']];const kbStatus=aggregateKeyboard(guesses,answer||'');keyboard.innerHTML='';rows.forEach(row=>{const wrap=document.createElement('div');wrap.className='flex gap-2 justify-center mb-2';row.forEach(key=>{const btn=document.createElement('button');const st=kbStatus[key];btn.className=`kbd px-3 py-2 rounded-lg backdrop-blur-sm ${st==='correct'?'bg-green-600 text-white':st==='present'?'bg-yellow-600 text-white':st==='absent'?'bg-gray-600 text-white':'bg-white/10 text-white'} hover:opacity-90`;btn.textContent=key;btn.addEventListener('click',()=>onKey(key));wrap.appendChild(btn);});keyboard.appendChild(wrap);});}

    async function handleEnter(){if(status!=='playing')return;const g=toUpper(cur);if(g.length!==wordLen)return showToast('Not enough letters');if(!isWordValid(g))return showToast('Not in dictionary');const next=[...guesses,g];guesses=next;cur='';buildGrid();if(g===answer){status='won';showToast('You got it! ðŸŽ‰');await saveProgress(today,getClientId(),{answer,guesses:next,status:'won'});return;}if(next.length>=attempts){status='lost';showToast(`Out of tries. Answer: ${answer}`);await saveProgress(today,getClientId(),{answer,guesses:next,status:'lost'});return;}await saveProgress(today,getClientId(),{answer,guesses:next,status:'playing'});renderKeyboard();}

    window.addEventListener('keydown',(e)=>{if(status!=='playing')return;if(e.key==='Enter')return handleEnter();if(e.key==='Backspace'){cur=cur.slice(0,-1);buildGrid();return;}if(/^[a-zA-Z]$/.test(e.key)){if(cur.length<wordLen)cur+=e.key.toUpperCase();buildGrid();}});

    function onKey(key){if(status!=='playing')return;if(key==='ENTER')return handleEnter();if(key==='âŒ«'){cur=cur.slice(0,-1);buildGrid();return;}if(/^[A-Z]$/.test(key)){if(cur.length<wordLen)cur+=key;buildGrid();}}

    async function bootstrap(){await loadDictionary();today=todayISO();todayLabel.textContent=today;answer='APPLE';wordLen=answer.length;attempts=wordLen+1;wordLenLabel.textContent=wordLen;attemptsLabel.textContent=attempts;buildGrid();renderKeyboard();}

    bootstrap();
  </script>
</body>
</html>
